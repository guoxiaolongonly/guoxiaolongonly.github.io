<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Xiaolong, lucky" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="程序猿">
<meta property="og:type" content="website">
<meta property="og:title" content="Xiaolong的个人博客">
<meta property="og:url" content="http://rngift.com/index.html">
<meta property="og:site_name" content="Xiaolong的个人博客">
<meta property="og:description" content="程序猿">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Xiaolong的个人博客">
<meta name="twitter:description" content="程序猿">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://rngift.com/"/>





  <title> Xiaolong的个人博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xiaolong的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">每一天都值得被认真对待</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/pastLove" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            爱过的人
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2018/05/23/Stringintern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/23/Stringintern/" itemprop="url">
                  String中intern方法的作用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-23T20:25:06+08:00">
                2018-05-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java基础/" itemprop="url" rel="index">
                    <span itemprop="name">Java基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>读完这篇文章你可以了解，String对象在虚拟机内存中的存放，intern的作用，这么多String对象的创建到底有什么区别，String 创建的对象有几个！！</p>
<h2 id="进入正题"><a href="#进入正题" class="headerlink" title="进入正题"></a>进入正题</h2><p>先科普几个知识点 </p>
<p>1.常量池存放于方法区中</p>
<p>2.jdk1.6 方法区放在永久代（java堆的一部分），jdk1.7 特别将字符串常量池移动到了的堆内存中（使用参数-XX:PermSize 和-XX:MaxPermSize指定大小），jdk1.8放在单独的元空间里面（-XX:MaxMetaspaceSzie设定大小），和堆相独立。所以导致string的intern方法因为以上变化在不同版本会有不同表现。</p>
<ol>
<li>jdk1.6将Hotspot虚拟机使用永久代来实现方法区，因为方法区的内存回收跟堆内存回收其实没什么区别，这样实现可以用垃圾收集器来管理这部分内存，但这样容易导致内存溢出（达到-XX:MaxPermSize）。<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/StringInternInJava/20180705190627133.png?raw=true" alt="这里写图片描述"></li>
</ol>
<p>JDK1.6，JDK1.7常量池的存放如下都存放于堆内存中<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/StringInternInJava/20180705191352953.png?raw=true" alt="这里写图片描述"><br>JDK1.8常量池的存放如下<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/StringInternInJava/20180705192916244.png?raw=true" alt="这里写图片描述"></p>
<p>具体可参考：<a href="https://blog.csdn.net/zhyhang/article/details/17246223/" target="_blank" rel="external">https://blog.csdn.net/zhyhang/article/details/17246223/</a></p>
<p>知道了常量池在内存中的存放后，我们需要先了解一下 String str=”abc”;和 String str =new String(“abc”);的区别</p>
<p>1.String str=”abc”；</p>
<p>JDK1.6<br>（1） 当常量池中不存在”abc”这个字符串的引用，在堆内存中new一个String对象，复制这个对象加入常量池，返回常量池中的对象。<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/StringInternInJava/20180705193530235.png?raw=true" alt="这里写图片描述"></p>
<p>（2） 当常量池中存在”abc”这个字符串对象，str指向这个对象的引用；</p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/StringInternInJava/20180705195051227.png?raw=true" alt="这里写图片描述"></p>
<p>JDK1.7以上<br>（1） 当常量池中不存在”abc”这个字符串的引用，在堆内存中new一个新的String对象，将这个对象的引用加入常量池。（跟1.6的区别是常量池不再存放对象，只存放引用。）<br>（2） 当常量池中存在”abc”这个字符串的引用，str指向这个引用；</p>
<p>2.String str =new String(“abc”)则是单纯的在堆内存中new一个String对象，通过StringBuilder 跟StringBuffer 构建的对象也是一样</p>
<p>3.intern方法 （返回常量池中该字符串的引用）</p>
<p>（1） <strong>当常量池中不存在”abc”这个字符串的引用，将这个对象的引用加入常量池，返回这个对象的引用。</strong><br>（2） <strong>当常量池中存在”abc”这个字符串的引用，返回这个对象的引用；</strong></p>
<p>测试代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">String str1 = <span class="string">"计算机"</span>;</div><div class="line">String str2 = <span class="string">"计算机"</span>;</div><div class="line">System.out.println(<span class="string">"str1==str2:"</span> + (str1 == str2));</div><div class="line"></div><div class="line">String str3 = <span class="keyword">new</span> String(<span class="string">"计算机"</span>);</div><div class="line">System.out.println(<span class="string">"str1==str3:"</span> + (str1 == str3));</div><div class="line">System.out.println(<span class="string">"str1==str3.intern():"</span> + (str1 == str3.intern()));</div><div class="line">System.out.println(<span class="string">"str2==str3.intern():"</span> + (str2 == str3.intern()));</div><div class="line"></div><div class="line">String str4 = <span class="keyword">new</span> String(<span class="string">"计算机"</span>);</div><div class="line">System.out.println(<span class="string">"str3==str4:"</span> + (str3 == str4));</div><div class="line">System.out.println(<span class="string">"str3.intern()==str4.intern():"</span> + (str3.intern() == str4.intern()));</div><div class="line"></div><div class="line"></div><div class="line">String str5 = <span class="keyword">new</span> StringBuilder(<span class="string">"软件"</span>).append(<span class="string">"工程"</span>).toString();</div><div class="line">System.out.println(<span class="string">"str5.intern() == str5:"</span> + (str5.intern() == str5));</div><div class="line"></div><div class="line">String str6 = <span class="keyword">new</span> String(<span class="keyword">new</span> StringBuilder(<span class="string">"物联网"</span>).append(<span class="string">"工程"</span>).toString());</div><div class="line">System.out.println(<span class="string">"str6.intern() == str6:"</span> + (str6.intern() == str6));</div><div class="line"></div><div class="line">String str7 = <span class="keyword">new</span> String(<span class="string">"物联网"</span>);</div><div class="line">System.out.println(<span class="string">"str7.intern() == str7:"</span> + (str7.intern() == str7));</div></pre></td></tr></table></figure>
<p>JDK1.8输出结果如下：</p>
<pre><code>str1==str2:true
str1==str3:false
str1==str3.intern():true
str2==str3.intern():true
str3==str4:false
str3.intern()==str4.intern():true
str5.intern() == str5:true
str6.intern() == str6:true
str7.intern() == str7:false
</code></pre><p>这里着重讲解一下为什么str5,str6和str7的结果不一样，</p>
<p>str7直接用new String（”物联网”）创建，”物联网”这字符串在<strong>一出现</strong>就自动创建成对象存放到常量池中，所以常量池里面存放的是”物联网”字符串的引用，并不是str7创建的对象的引用。</p>
<p>str5是通过StringBuilder构建的 在new StringBuilder(“软件”).append(“工程”).toString方法运行后,”软件工程”这个字符串对象才第一次出现。执行了intern方法后str5才被放到常量池中，此时str5跟str5.intern是同一个对象。</p>
<p>str6是作为对照组出现，这里为了确认StringBuilder 在toString方法执行后会不会把最终字符串放进常量池。很显然并没有，所以str6的intern才会跟str6是同一个对象。同时它也能验证出str7的new String()方式在初始化的时候就会把”物联网”字符串放进常量池中，同理我们可以得出在str5构建的时候常量池里面加入了”软件”,”工程”这两个字符串（可以自己动手去验证一下！！）。</p>
<p>JDK1.7结果如下</p>
<pre><code>str1==str2:true
str1==str3:false
str1==str3.intern():true
str2==str3.intern():true
str3==str4:false
str3.intern()==str4.intern():true
str5.intern() == str5:true
str6.intern() == str6:true
str7.intern() == str7:false
</code></pre><p>当然JDK1.6我们也能大致明确，输出结果会如下</p>
<pre><code>str1==str2:true
str1==str3:false
str1==str3.intern():true
str2==str3.intern():true
str3==str4:false
str3.intern()==str4.intern():true
str5.intern() == str5:false
str6.intern() == str6:false
str7.intern() == str7:false
</code></pre><p>分析一下jdk1.6中 str5.intern() == str5的结果为什么为false，这里可以这么看在软件工程这个对象中构建完成之后，常量池里面其实存放的只有“软件”,”工程”这两个字符串，而”软件工程”这个字符串是存放于堆内存中的。所以JDK1.6执行了intern后会把“软件工程”复制到常量池中，并返回常量池中的对象。常量池中的”软件工程”跟堆内存中的软件工程并不是同一个。</p>
<p>因为没有尝试过，如果jdk1.6有不一致的地方欢迎大家指点。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.String对象可能会在堆内存中分配一块空间创建一个String对象，在常量池中创建该对象的复制<em>jdk 1.6</em>（或引用<em>jdk 1.7</em>及以上），也可能直接指向常量池（永久带）中的引用（例String str=”xxx”）。还有一种可能是直接在堆内存中分配一块空间创建一个String对象（例 String str=new String(xxx)）。</p>
<p>2.intern方法可以看成返回常量池中该字符串对象的引用。如果没有该字符串对象就把这个对象（或引用）加到常量池。</p>
<p>3.jdk1.6跟jdk1.7以上的区别是当常量池中不存在这个字符串，jdk1.6是直接复制对象到常量池，而jdk1.7以上是把对象的引用加入常量池。</p>
<p>4.类似于”abc”这样的字符串,在第一次被使用到(比如String a=”abc”或者String a=new String(“abc”)或者”abc”.equals(xxx))后就会被加载到常量池中去。</p>
<p>5.面试问题：</p>
<p>（1）现在当有人问 String str = new String(“abc”);创建了几个对象，常量池有abc字段是1个，常量池没有”abc”字段则是2个。<br>（2）String str=”abc”;创建了几个对象（如果常量池里面已经有对象了就是0个。如果没有，JDK1.6 2个，JDK1.7以上 1个）;<br>（3）new String(“abc”).intern();创建了几个对象（如果常量池里面已经有该字符串对象了就是1个，如果没有就是两个）</p>
<p>以上是关于String中intern的作用和个人对于内存的一些理解，希望大家有所收获，也期待和大家交流。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2018/05/02/RecyclerViewAbout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/02/RecyclerViewAbout/" itemprop="url">
                  RecyclerView的那些事
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-02T23:23:26+08:00">
                2018-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="RecyclerView是什么"><a href="#RecyclerView是什么" class="headerlink" title="RecyclerView是什么"></a>RecyclerView是什么</h3><p>RecyclerView是V7兼容包下的一个列表布局，可以实现复杂的列表，我们经常拿他与ListView做比较，相较于原来的列表布局实现，RecyclerView提供的方法更加开放，给用户提供了更多的可选择实现方式。<br>在动画和加载效率方面做了更多优化。</p>
<h3 id="使用RecyclerView-有什么优势？"><a href="#使用RecyclerView-有什么优势？" class="headerlink" title="使用RecyclerView 有什么优势？"></a>使用RecyclerView 有什么优势？</h3><h4 id="1-自定义LayoutManager"><a href="#1-自定义LayoutManager" class="headerlink" title="1.自定义LayoutManager"></a>1.自定义LayoutManager</h4><p>RecyclcerView不止支持实现ListView结构，也支持实现GridView结构，甚至以前用ListView，GridView实现的瀑布流和一些复杂的样式都能用RecyclcerView来实现。</p>
<p>RecyclerView默认实现了三种LayoutManager(LinearLayoutManager,GridLayoutManager,StaggeredGridLayoutManager)分别用来实现ListView,GridView和瀑布流的效果，如果这些布局效果不满足你的应用，那你可以自己重写LayoutManager写一个你喜欢的样式。</p>
<p><img src="https://raw.githubusercontent.com/guoxiaolongonly/xiaolongonly.github.io/master/uploads/CustomLayoutManage2.png" alt="CustomLayoutManage2"><br><img src="https://raw.githubusercontent.com/guoxiaolongonly/xiaolongonly.github.io/master/uploads/CustomLayoutManager.png" alt="CustomLayoutManage2"></p>
<h4 id="2-自定义ItemDecoration（分割线）"><a href="#2-自定义ItemDecoration（分割线）" class="headerlink" title="2.自定义ItemDecoration（分割线）"></a>2.自定义ItemDecoration（分割线）</h4><p>ListView的实现支持我们设置一个自定义的Drawable,来做分割线。</p>
<p>RecyclerView开放了一个ItemDecoration类,我们可以自己实现这个类来做出花哨的装饰样式，包括分割线。</p>
<p>以前GridView实现不了分割线，RecyclerView可以！！</p>
<p>RecyclerView提供了自带的分割线实现类DividerItemDecoration。<br><img src="https://raw.githubusercontent.com/guoxiaolongonly/xiaolongonly.github.io/master/uploads/Divider.png" alt="CustomLayoutManage2"></p>
<h4 id="3-自定义ItemTouchHelper"><a href="#3-自定义ItemTouchHelper" class="headerlink" title="3.自定义ItemTouchHelper"></a>3.自定义ItemTouchHelper</h4><p>RecyclerView支持自己实现ItemTouchHelper,用来做Item的一些移动等手势操作。<br><img src="https://raw.githubusercontent.com/guoxiaolongonly/xiaolongonly.github.io/master/uploads/MainTouchHelper.png" alt="MainTouchHelper"></p>
<h4 id="4-Adapter中获取item的类型"><a href="#4-Adapter中获取item的类型" class="headerlink" title="4.Adapter中获取item的类型"></a>4.Adapter中获取item的类型</h4><p>RecyclerView支持实现getItemViewType根据不同的数据或者某些条件返回不同的itemType,而在Inflate的时候用户可以根据不同的itemType inflate不同的布局。</p>
<h4 id="5-列表局部刷新"><a href="#5-列表局部刷新" class="headerlink" title="5.列表局部刷新"></a>5.列表局部刷新</h4><p>RecyclerView提供了局部刷新的接口，通过局部刷新，就能避免调用许多无用的bindView.<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/RecyclerView/5757771-d96686ca22daba3a.gif?raw=true" alt="rv"></p>
<p>(RecyclerView和ListView添加，移除Item效果对比)</p>
<p>结合RecyclerView的缓存机制，看看局部刷新是如何实现的：<br>以RecyclerView中notifyItemRemoved(1)为例，最终会调用requestLayout()，使整个RecyclerView重新绘制，过程为：<br>onMeasure()–&gt;onLayout()–&gt;onDraw()</p>
<p>其中，onLayout()为重点，分为三步： </p>
<ol>
<li>dispathLayoutStep1()：记录RecyclerView刷新前列表项ItemView的各种信息，如Top,Left,Bottom,Right，用于动画的相关计算； </li>
<li>dispathLayoutStep2()：真正测量布局大小，位置，核心函数为layoutChildren()； </li>
<li>dispathLayoutStep3()：计算布局前后各个ItemView的状态，如Remove，Add，Move，Update等，如有必要执行相应的动画.</li>
</ol>
<p>其中，layoutChildren()流程图：<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/RecyclerView/5757771-acfb27c3c85a4b76.jpg?raw=true" alt="s"></p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/RecyclerView/5757771-e4b778c6516575bf.png?raw=true" alt="s"><br>当调用notifyItemRemoved时，会对屏幕内ItemView做预处理，修改ItemView相应的pos以及flag(流程图中红色部分)：<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/RecyclerView/5757771-e05858ff4b7193d4.png?raw=true" alt="s"></p>
<p>当调用fill()中RecyclerView.getViewForPosition(pos)时，RecyclerView通过对pos和flag的预处理，使得bindview只调用一次.</p>
<p>需要指出，ListView和RecyclerView最大的区别在于数据源改变时的缓存的处理逻辑，ListView是”一锅端”，将所有的mActiveViews都移入了二级缓存mScrapViews，而RecyclerView则是更加灵活地对每个View修改标志位，区分是否重新bindView。</p>
<h4 id="6-View缓存"><a href="#6-View缓存" class="headerlink" title="6.View缓存"></a>6.View缓存</h4><p><strong>缓存层级</strong></p>
<p>RecyclerView比ListView多两级缓存，支持多个离ItemView缓存，支持开发者自定义缓存处理逻辑，支持所有RecyclerView共用同一个RecyclerViewPool(缓存池)。</p>
<p>具体来说：<br>ListView(两级缓存)：<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/RecyclerView/5757771-936b333b772f7384.png?raw=true" alt="ListView"><br>RecyclerView(四级缓存)：<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/RecyclerView/5757771-e3e8d77f425aec56.jpg?raw=true" alt="RecyclerView"></p>
<p>ListView和RecyclerView缓存机制基本一致：</p>
<p>1). mActiveViews和mAttachedScrap功能相似，意义在于快速重用屏幕上可见的列表项ItemView，而不需要重新createView和bindView；</p>
<p>2). mScrapView和mCachedViews + mReyclerViewPool功能相似，意义在于缓存离开屏幕的ItemView，目的是让即将进入屏幕的ItemView重用.</p>
<p>3). RecyclerView的优势在于a.mCacheViews的使用，可以做到屏幕外的列表项ItemView进入屏幕内时也无须bindView快速重用；b.mRecyclerPool可以供多个RecyclerView共同使用，在特定场景下，如viewpaper+多个列表页下有优势.客观来说，RecyclerView在特定场景下对ListView的缓存机制做了补强和完善。</p>
<p><strong>缓存方式</strong></p>
<p>1). RecyclerView缓存RecyclerView.ViewHolder，抽象可理解为：<br>View + ViewHolder(避免每次createView时调用findViewById) + flag(标识状态)；<br>2). ListView缓存View。</p>
<p>缓存不同，二者在缓存的使用上也略有差别，具体来说：<br>ListView获取缓存的流程：<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/RecyclerView/5757771-ce5ac0ef80b56caf.jpg?raw=true" alt="listview缓存"><br>RecyclerView获取缓存的流程：<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/RecyclerView/5757771-86039439e6145e39.jpg?raw=true" alt="recyclerView缓存"></p>
<p>1). RecyclerView中mCacheViews(屏幕外)获取缓存时，是通过匹配pos获取目标位置的缓存，这样做的好处是，当数据源数据不变的情况下，无须重新bindView：<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/RecyclerView/5757771-a252a921951da595.gif?raw=true" alt="ss"><br>而同样是离屏缓存，ListView从mScrapViews根据pos获取相应的缓存，但是并没有直接使用，而是重新getView（即必定会重新bindView）</p>
<p>2). ListView中通过pos获取的是view，即pos–&gt;view；<br>RecyclerView中通过pos获取的是viewholder，即pos –&gt; (view，viewHolder，flag)；<br>从流程图中可以看出，标志flag的作用是判断view是否需要重新bindView，这也是RecyclerView实现局部刷新的一个核心.</p>
<h3 id="只用一个RecyclerView如何实现复杂布局"><a href="#只用一个RecyclerView如何实现复杂布局" class="headerlink" title="只用一个RecyclerView如何实现复杂布局"></a>只用一个RecyclerView如何实现复杂布局</h3><p>有个需求是这样的，我们需要做一个图片列表的展示但是不同的图片我要给他不一样的权重来让他显示不同的占比。比如下图。</p>
<p><img src="https://raw.githubusercontent.com/guoxiaolongonly/xiaolongonly.github.io/master/uploads/imageRecyclerView.png" alt="imageRecyclerView"></p>
<p>如果页面结构比较简单的情况下(默认顶部区域和最底部区域是一样的)可能会把中间那两块区域做成一个特殊的ViewType.只有中间的八个小方格和两个大方格是特殊区域，这个时候就可以把八个小方格做一个特殊的ViewType，两个小方格做一个特殊的ViewType.加载进去。</p>
<p>如果所有的方格都是列表中的一个项，这边有可能需要解决数据源的问题。</p>
<p>但其实这整个布局用一个GridLayoutManager能够一次实现。</p>
<p>这都要归功于GridLayoutManager提供的一个方法setSpanSizeLookup，它提供了一个SpanSizeLookup的抽象，我们可以实现它的getSpanSize方法。<br>有这个方法，我们可以把不同大小的布局设置不同的ViewType，getSpanSize给不同的ViewType设置不同的占位。最终达到一个RecylcerView实现复杂布局的效果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">gridLayoutManager.setSpanSizeLookup(<span class="keyword">new</span> GridLayoutManager.SpanSizeLookup() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSpanSize</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">               <span class="keyword">switch</span> (displayAdapter.getItemViewType(position)) &#123;</div><div class="line">                   <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                       <span class="keyword">return</span> <span class="number">4</span>;</div><div class="line">                   <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                       <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">                   <span class="keyword">case</span> <span class="number">3</span>:</div><div class="line">                       <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line">                   <span class="keyword">default</span>:</div><div class="line">                       <span class="keyword">return</span> <span class="number">4</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125;);</div></pre></td></tr></table></figure>
<p>GridLayoutManager其实就是LayoutManager的一个实现，从这个方法可以看出只要我们掌握了自定义的LayoutManager，整个RecyclerView想长什么样子就都掌握在你的手中了。</p>
<p><img src="https://raw.githubusercontent.com/guoxiaolongonly/xiaolongonly.github.io/master/uploads/Gridlayout.png" alt="实现效果"></p>
<p>demo地址：<a href="https://github.com/guoxiaolongonly/RecyclerViewDemo" target="_blank" rel="external">https://github.com/guoxiaolongonly/RecyclerViewDemo</a></p>
<p>参考：</p>
<p>Android ListView与RecyclerView对比浅析–缓存机制：<a href="https://blog.csdn.net/tencent_bugly/article/details/52981210" target="_blank" rel="external">https://blog.csdn.net/tencent_bugly/article/details/52981210</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2018/04/03/BluetoothDoc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/04/03/BluetoothDoc/" itemprop="url">
                  从零开始写一个蓝牙SPP通讯
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T23:23:26+08:00">
                2018-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android蓝牙/" itemprop="url" rel="index">
                    <span itemprop="name">Android蓝牙</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="流程思考"><a href="#流程思考" class="headerlink" title="流程思考"></a>流程思考</h3><p>这边有几个需求点，</p>
<p>1.<strong>一个统一的蓝牙管理类</strong>，BtManger,针对蓝牙连接和各种数据回调处理。</p>
<p><img src="https://raw.githubusercontent.com/guoxiaolongonly/xiaolongonly.github.io/master/uploads/btManager.png" alt="TIM截图20180330145900.png"></p>
<p>变量说明一下，<br>（1）BluetoothAdapter 是一个本地蓝牙适配器，可以用来查询设备，获取已配对设备列表，通过MAC连接蓝牙设备，做蓝牙接入监听，还有蓝牙开关状态等等。可以通过获取系统的BluetoothManager来获取，也可以直接通过BluetoothAdapter获取一个默认的BluetoothAdapter,</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">BluetoothManager btManager = (BluetoothManager) context</div><div class="line">               .getSystemService(Context.BLUETOOTH_SERVICE);</div><div class="line">BluetoothAdapter bluetoothAdapter = btManager.getAdapter;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">BluetoothAdapter bluetoothAdapter = BluetoothAdapter.getDefaultAdapter();</div></pre></td></tr></table></figure>
<p>两种方式的区别在于，第一种方式可以通过btManager来获取蓝牙的一些状态信息，包括已连接的设备列表等…</p>
<p>（2）Context上下文，如果有全局的蓝牙处理需求，建议在Application创建的时候传入应用上下文,这个上下文需要注册广播还有一些其他的功能，如果不是声明周期长的Activiy会导致内存泄露。<br>（3）BluetoothTransferService 传输服务类，提供设备连接，还有蓝牙Socket数据传输。后面会详细讲到。<br>（4）BluetoothStatusReceiver 广播接收器，用来接收蓝牙状态的广播，蓝牙开启/关闭。<br>（5）BluetoothScanRecevier  广播接收器，用来接收蓝牙设备扫描的广播<br>（6）BtManager 蓝牙管理类的单实例，因为蓝牙SPP对接整个周期只做一个，没必要每次都创建新的连接。<br>（7）DeviceHandler  这个类用来做跨线程的诸多状态的通信。（整个连接，监听，和传输过程都放在线程中）</p>
<p>2.<strong>蓝牙搜索</strong>，需要有一个能搜索附近的蓝牙的回调<br><img src="https://raw.githubusercontent.com/guoxiaolongonly/xiaolongonly.github.io/master/uploads/btScanCallBack.png" alt="TIM图片20180328151248.png"><br>整个设计大致如下，BluetoothDevice为蓝牙设备信息，rssi为信号强度，提供单设备扫描，扫描超时，和全部扫描结束列表回调</p>
<p>3.<strong>蓝牙对接</strong>，需要有一个能让用户知道蓝牙连接状态的回调  成功，失败，中断等..</p>
<p><img src="https://raw.githubusercontent.com/guoxiaolongonly/xiaolongonly.github.io/master/uploads/btDataTransferCallBack.png" alt="TIM图片20180328152721.png"><br>四个方法分别 是连接中,已连接,断开连接,等待接入,连接到设备</p>
<p>4.<strong>蓝牙数据传输(发送)</strong>，这个是重点，分析一下这一块需要的功能，（1）发送消息的功能，称之为sendMessage。（2）消息可能是一个文件，可能是一长串字节流，可能是一个int数组,也可能是一串字符串，好了这边这边提供一个抽象。提供一个基础的RequestMessage，和getRequestBody根据不同的文件类型做策略包装。甚至可以提供静态工厂来包装一个这样的对象;</p>
<p>5.<strong>蓝牙数据传输(接收)</strong>，这个也是重点，分析一下这一块需要的功能，（1）接收消息的功能，当消息接收完毕后告诉用户。（2）消息可能是一个文件，可能是一长串字节流，可能是一个int数组等等。提供一个扩展的接口用来做消息处理，针对不同的消息做不同的处理。提供一个基础的 ResponseMessage，getResponseBody也做策略封装。</p>
<p>6.分包传输，分包接收这类的机制。降低仪器数据量大小限制</p>
<p>7.最后针对以上的功能提供一些静态的方法做数据处理，ByteUtil,FileUtil等。</p>
<h3 id="协议定制"><a href="#协议定制" class="headerlink" title="协议定制"></a>协议定制</h3><p>需求如下既要考虑到不同文件的传输，又要考虑到文件传输的大小限制。</p>
<h4 id="协议可以这么做"><a href="#协议可以这么做" class="headerlink" title="协议可以这么做"></a>协议可以这么做</h4><ol>
<li>包头，当接收到头部的时候代表一次请求开始，</li>
<li>文件名称，如果当前传输为文件的话填入文件名称否则为00 00;</li>
<li>总包数 针对数据太大的问题采用分包发送，AllPack总包</li>
<li>分包  当前传出分包</li>
<li>数据区长度  传输的数据区长度，用来确认接下来需要读取的字节数</li>
<li>数据    待传输数据，可以为空</li>
<li>校验和  针对前面传输数据的累加和，取低位</li>
</ol>
<h4 id="具体内容如下"><a href="#具体内容如下" class="headerlink" title="具体内容如下"></a>具体内容如下</h4><p><strong>包头</strong>  0x7e 0x7e 两个十六进制数 占两字节</p>
<p><strong>文件名称</strong> 00 00 … 占50字节大致能传16个UTF-8中文字符和1个英文字符，或者50个英文字符，扩展名算进去。</p>
<p><strong>总包数</strong>     00 01    占两个字节<br><strong>分包</strong>       00 01   占两个字节<br><strong>数据区域长度</strong> 00 01  占两个字节<br><strong>数据</strong>          01   占1-n个字节<br><strong>校验和</strong>            00  占一个字节，取低位 假设文件名为空数据为01 校验和为 7e+7e+01+01+01+01=01 00 取低位得00</p>
<h4 id="一个完整的包如下"><a href="#一个完整的包如下" class="headerlink" title="一个完整的包如下"></a>一个完整的包如下</h4><p>7e 7e  00 00… 00(50个00) 00 01 00 01  00 01 00 01 00</p>
<p>完美！！</p>
<h2 id="编码阶段"><a href="#编码阶段" class="headerlink" title="编码阶段"></a>编码阶段</h2><p>demo地址：<a href="https://github.com/guoxiaolongonly/AndroidBluetooth" target="_blank" rel="external">https://github.com/guoxiaolongonly/AndroidBluetooth</a></p>
<p>实现简单的聊天功能。文件名称也采用跟文件内容一样长度（2字节）加名称（长度字节）。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2018/03/13/AnnualSummary 2017/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/03/13/AnnualSummary 2017/" itemprop="url">
                  2017年总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-13T15:19:37+08:00">
                2018-03-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/阶段性总结/" itemprop="url" rel="index">
                    <span itemprop="name">阶段性总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="闲谈"><a href="#闲谈" class="headerlink" title="闲谈"></a>闲谈</h3><p>有些时候真的不得不佩服有一些人真的是牛逼，跟我同事对比才发现人家看了编程思想是真的读懂了，我看了编程思想是看了一遍。最近问了他一些问题感觉他都能对答如流，想各种解决方案，不禁感觉自己书是不是白看了。最近重新把java编程思想拿起来看，才发现有很多以前没注意到的细节。书确实要多读，一遍没读透就读两遍，三遍。再困难也不要忘了提升自己！！</p>
<h3 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h3><p>这边其实更多的是对去年的反思吧，感觉很多时候基本都是要打脸之后才能明白自己所处的位置。在经过了一轮简历的投递和内推之后发现自己并没有特别多的优势，基本上全军覆没了，连面试机会都没有，这里分析一下问题根本原因，现在Android开发真的是烂大街，作为一个两年工作经验的，想找一份好的工作真的很难。去年一整年也基本没有太大的提升，仅仅是把重复工作做的更加熟练而已，所以也思考出自身的一些问题和解决方案。</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ol>
<li>大厂基本都直接校招，社招的要求基本很严格。</li>
<li>小公司大部分技术不成熟，很多时候一个人要做很多的活，接触的面虽然广，但是不精，这个其实就跟做重复工作没什么区别了。</li>
<li>个人上跳槽频繁，让HR觉得稳定性不高。</li>
<li>技术并不是过硬，虽有博客github，并没有多大优势。</li>
</ol>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><ol>
<li>了解一线大厂需求，充实简历</li>
<li>小公司尽量避免不去了。</li>
<li>找一家的公司稳定待个几年。</li>
<li>技术充实，每个月一篇博客，每天坚持github push开源</li>
<li>打好扎实的java基础，多线程编程，网络编程思想，内存管理，java虚拟机</li>
</ol>
<p>以上！！</p>
<hr>
<h3 id="2018-03-17-00-44-37"><a href="#2018-03-17-00-44-37" class="headerlink" title="2018-03-17 00:44:37"></a>2018-03-17 00:44:37</h3><p>那个…. 找到简历没回复的原因了，个人简历都忘了填联系方式了。一个朋友帮我内推的时候发现的。艾玛，果然本命年！！</p>
<h3 id="2018年3月22日-22-52-52"><a href="#2018年3月22日-22-52-52" class="headerlink" title="2018年3月22日 22:52:52"></a>2018年3月22日 22:52:52</h3><p>思考了一下最近面试的一些问题（没回答好的）。</p>
<h4 id="1-如何优化页面加载"><a href="#1-如何优化页面加载" class="headerlink" title="1.如何优化页面加载"></a>1.如何优化页面加载</h4><p>在这边其实我一直在View层面考虑这个问题<br>回答了一些点，比如<br>1.减少View的层级，尽量不使用背景<br>2.List中复用View<br>3.自定义控件开硬件加速（- -！！然后被问了硬件加速原理，呃，这边其实就是想让你知道GPU可以加速绘制）还是没有回答到点，然后面试官引导了一下我，ListView的加载卡顿怎么办。<br>4.一想就是把耗时操作写到线程中去（还是没get到点）<br>5.等到滑动结束后再做加载（还是没get到点）<br>6.最后其实是CPU可能在做一些其他计算也会影响界面的性能。那这里其实可以在页面加载的时候减少一些后台操作。</p>
<p>2.关于性能优化这一块<br>1.我直接回答MAT，找到一些无法被释放的对象，排查相应的内存泄露原因。<br>面试官继续问直接用MAT吗？还有其实你这个只是在排查内存溢出的情况，如果是性能优化其实更多的是从一些对象维护了一些冗余的数据。导致这些类没办法做释放，这一块需要考虑到性能优化。<br>那么这边其实，可以先用Memory Monitor看页面内存结构，有哪一些大对象，System Trace，来看一下哪一些页面启动花时间（耗CPU）。然后再用MAT来分析具体是哪些对象。<br>性能优化无异于以下几个点<br>1.从渲染过程优化 View绘制，层级等。<br>2.一些计算过程可以简化尽量简化<br>3.内存相关，这个时候就是排查大对象，内存占用。<br>4.电量相关，啊这个一般没人管。Android8.0对后台进程耗电做了优化。<br>5.具体可以看看这个 <a href="http://hukai.me/android-performance-patterns/" target="_blank" rel="external">http://hukai.me/android-performance-patterns/</a> 总共6季</p>
<p>以上是性能优化相关接下来是java基础Android基础和一些数据结构，算法和设计模式了。</p>
<h4 id="java基础"><a href="#java基础" class="headerlink" title="java基础"></a>java基础</h4><h5 id="1-接口和抽象的区别"><a href="#1-接口和抽象的区别" class="headerlink" title="1.接口和抽象的区别"></a>1.接口和抽象的区别</h5><p>接口 implements 多继承，灵活易扩展组合。</p>
<p>抽象 extends abstracts关键字修饰 单继承 内部可以带有实现。</p>
<p>抽象不易于维护，接口优于抽象</p>
<h5 id="2-集合框架：HashMap的实现原理"><a href="#2-集合框架：HashMap的实现原理" class="headerlink" title="2.集合框架：HashMap的实现原理"></a>2.集合框架：HashMap的实现原理</h5><p>散列桶，每个桶都实现了一个链表，如果hash值相等了，那么就往相应链表里加。链表的查询效率是O（n） jdk1.8采用了红黑树结构，当链表长度大于阈值8则转为红黑树 查询效率更高O（lgn）<br>扩容系数是0.75，2倍扩容，默认大小16。 java建议容器类如果能确定大小需手动指明大小。</p>
<p>hashmap和hashtable 的区别，hashtable的方法带有synchronize关键字，是线程安全的。hashmap不是。<br>jdk1.4出的ConcurrentUtil包  有一个 ConcurrentHashMap提供了一种分段锁机制，比hashtable更高效。<br>CopyOnWriteArrayList,CopyOnWriteArraySet这个是concurrent工具包里面的另外两个线程安全的集合。</p>
<h5 id="3-多线程"><a href="#3-多线程" class="headerlink" title="3.多线程"></a>3.多线程</h5><p>violate关键字和synchronized 关键字</p>
<p>乐观锁悲观锁，讲一下乐观锁，乐观锁就是不对数据加锁，每次更新拉一个版本，谁先提交算谁赢。<br>悲观锁则是需要对数据做加锁。以实现资源同步。</p>
<p>Lock和synchronized</p>
<p>这边也没回答好，但其实是Lock更灵活，他可以放在异常捕获finally中来解除资源占用。</p>
<h5 id="5-内存相关"><a href="#5-内存相关" class="headerlink" title="5.内存相关"></a>5.内存相关</h5><p>1.内存分区 方法区，虚拟机栈，本地方法栈，堆，程序计数器 他们分别做什么的。这个就答不出来了<br>2.类引用的引用什么，当然是地址啦。不要覆盖toString方法可以打印的。</p>
<h4 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h4><p>几种排序算法还有他们的时间复杂度。  时间按复杂度。。。。</p>
<p>1.选择排序：不稳定，时间复杂度 O(n^2)<br>2.插入排序：稳定，时间复杂度 O(n^2)<br>3.冒泡排序：稳定，时间复杂度 O(n^2)<br>4.堆排序：不稳定，时间复杂度 O(nlog n)<br>5.归并排序：稳定，时间复杂度 O(nlog n)<br>6.希尔排序：不稳定，时间复杂度 平均时间 O(nlogn) 最差时间O(n^s) 1&lt;s&lt;2<br>7.快速排序：不稳定，时间复杂度 最理想 O(nlogn) 最差时间O(n^2)</p>
<p>快排就选取一个点其他数据往两边排，然后两边选点再排，分治思想</p>
<h4 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h4><p>单例，工厂，享元，策略，装饰器，适配器，建造者，动态代理，代理…等等等</p>
<p>反正我是很容易把策略，装饰器，适配器搞混。。 艾玛24种，这个得整理一下.</p>
<p>被问的一个问题是最快的单例模式，用枚举实现。听的我一脸懵，后面发现Effective Java 上面有相关的内容。</p>
<h4 id="Android基础"><a href="#Android基础" class="headerlink" title="Android基础"></a>Android基础</h4><p>老生常谈的那些，Activity启动，数据存储，页面恢复，事件分发，View绘制，三种动画，IPC，多线程的几种方式，Binder，Handler,ThreadLocal。<br>然后就是个gradle 构建项目<br>然后就是一些能使用到的技术，插件化，模块化，AOP编程。<br>然后就是闲谈一些经验了。</p>
<h4 id="TCP-IP"><a href="#TCP-IP" class="headerlink" title="TCP/IP"></a>TCP/IP</h4><p>三次握手</p>
<h4 id="IO-NIO"><a href="#IO-NIO" class="headerlink" title="IO/NIO"></a>IO/NIO</h4><p>普通IO:直接操作流</p>
<p>NIO:操作数据缓冲区 ，DataBuffer,Channel，Selector</p>
<p>这是两场面试的心得。有没写到的再补充</p>
<p>总结：2年了，还是那么菜。</p>
<p>接下来要看的一些东西</p>
<ol>
<li>Effective JAVA </li>
<li>JAVA多线程编程</li>
<li>JVM虚拟机</li>
<li>JAVA网络编程</li>
<li>设计模式</li>
<li>IO/NIO</li>
</ol>
<h2 id="2018年4月1日-18-17-40"><a href="#2018年4月1日-18-17-40" class="headerlink" title="2018年4月1日 18:17:40"></a>2018年4月1日 18:17:40</h2><p>找工作的事情放缓，着手学习，写代码，感谢这次面试经历。特别是美图的Boss!!</p>
<p><strong><em>By xiaolong：You have a dream,you got to protect it!</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2018/02/09/TravelFrog/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/09/TravelFrog/" itemprop="url">
                  写一个旅行青蛙攻略APP
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-09T09:11:09+08:00">
                2018-02-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/个人开源/" itemprop="url" rel="index">
                    <span itemprop="name">个人开源</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="界面效果如下"><a href="#界面效果如下" class="headerlink" title="界面效果如下"></a>界面效果如下</h1><p><img src="https://raw.githubusercontent.com/guoxiaolongonly/TravelGuaGuide/master/screen/launcher.png" alt="启动页"><br><img src="https://raw.githubusercontent.com/guoxiaolongonly/TravelGuaGuide/master/screen/main.png" alt="首页"><br><img src="https://raw.githubusercontent.com/guoxiaolongonly/TravelGuaGuide/master/screen/animal.png" alt="小伙伴"><br><img src="https://raw.githubusercontent.com/guoxiaolongonly/TravelGuaGuide/master/screen/collect.png" alt="收藏"><br><img src="https://raw.githubusercontent.com/guoxiaolongonly/TravelGuaGuide/master/screen/specialy.png" alt="特产"><br><img src="https://raw.githubusercontent.com/guoxiaolongonly/TravelGuaGuide/master/screen/name.png" alt="称号"></p>
<pre><code>不要忘了我们的所有数据和界面都可以在github的json文件里面配置有需要的小伙伴自行拿去用吧!!
</code></pre><p><a href="https://github.com/guoxiaolongonly/TravelGuaGuide" target="_blank" rel="external">项目github地址</a><br><a href="https://fir.im/qwgl" target="_blank" rel="external">Apk下载地址</a></p>
<h1 id="设计意图"><a href="#设计意图" class="headerlink" title="设计意图"></a>设计意图</h1><p>最近旅行青蛙很火，我自己也在玩，然后发现一个痛点是每次找小动物喜欢吃什么，每个道具的用途，都需要打开浏览器搜索。实在不能忍，感觉很痛，于是决心自己写一个APP攻略！！</p>
<h1 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h1><p>1.需要先对界面上的每个功能放一张图解，还有基本玩法操作！！</p>
<p>2.针对出现的每个道具的名称和用途做一个分类查看器，描述名称，用途等… 比如说商城道具和带回来的特产，收藏品，抽奖的奖品等…</p>
<p>3.如果单机版其实就这么考虑。后面觉得应该做一个动态数据的功能。（因为如果游戏有新版本更新了APP也得更新新版本，所以我想给APP一个接口，用来传输每次更新的数据。这样我们就不用每次发一个版本了。 very nice!!）</p>
<p>4.既然需要提供接口，就需要一个服务器了。这边其实是有多种考虑。</p>
<ul>
<li>bomb后端云，这种免费后端数据库可以一键式增删改查，这个可是上上之选。</li>
<li>写个页面，导入jsoup，动态爬数据，技术帝的不二选择，不过网页经常变感觉还是很蛋疼的。</li>
<li>哈哈哈哈哈哈，因为我比较懒，不想再去看文档，所以在github上面写了一个json文件，发现文件在github上的页面结构好像跟平时json请求的一样，试着做了一下请求。发现鸡然可以，那就用github来维护吧，反正博客都github上搭过了)</li>
</ul>
<h1 id="产品规划"><a href="#产品规划" class="headerlink" title="产品规划"></a>产品规划</h1><pre><code>coding之前的一些其他细节，首现是需要什么样的页面，怎样才能长得好看。噗，自己写APP都要兼职PM.UI.UE。 心疼的抱住了自己。  
</code></pre><p>1.页面既定的规划就是提供一个首页，实现列表对每个模块做划分，</p>
<ul>
<li>入门操作，因为日版的APP很多东西还是看不懂的，做一个引导用户入门。</li>
<li>商店道具和作用介绍</li>
<li>收藏品介绍</li>
<li>特产介绍</li>
<li>称号介绍</li>
<li>小动物喜欢吃什么</li>
<li>进阶攻略 提供一些骨灰级玩家需要的信息。（比如收割草，给小动物喂食什么合适等等..）</li>
<li>更新数据</li>
</ul>
<ol>
<li>根据需求其实已经很明了了首页6个tab，<ul>
<li>入门和进阶</li>
<li>小动物介绍</li>
<li>商店道具介绍</li>
<li>特产介绍</li>
<li>称号介绍</li>
<li>收藏品介绍</li>
<li>另外配置一个侧拉的View用来展示作者介绍，和数据更新，2333，装逼用！！</li>
</ul>
</li>
</ol>
<h1 id="Then-coding"><a href="#Then-coding" class="headerlink" title="Then coding"></a>Then coding</h1><p>主要是考虑动态配置问题，不同数据分配不同页面</p>
<p>1.首页一个列表用来展示所有模块</p>
<p>2.模块下面可能有子模块，根据类别启动子模块的Activity。</p>
<p>3.功能，不同功能展示的页面效果也不一样。gridView</p>
<ul>
<li>小动物，中图，中文字描述，点击查看详情gridView</li>
<li>商店道具，中图，中文字描述，点击查看详情gridView</li>
<li>特产，小图，小文字描述，点击查看详情gridView</li>
<li>称号，中图，中文字描述，点击查看详情gridView</li>
<li>收藏品，中图，中文字描述，点击查看详情gridView</li>
<li>入门和进阶，子模块，实现做图右文字列表做选择gridView</li>
<li>详情页大图大文字listView 图片+文字每个段落</li>
<li>预留一个webActivity做web加载。 预留一个TextActivity做文本加载</li>
</ul>
<p>4.两种类型的模块选择页  ModularGridViewActivity,ModularListViewActivity.</p>
<p>5.三种详情查看页 BigPicDetailActivity,WebActivity,TextActivity</p>
<p>6.两种描述页 MiddleDecribeActivity,SmallDeScribeActivity</p>
<p>7.侧拉菜单</p>
<p>8.关于APP</p>
<p>最近太忙了，没时间写这个，今天花了一天时间把它全部做完了，功能设计什么的都不难，就是界面和一些交互体验，还有素材整理花了点时间。最终实现的结果可能跟之前预想的不太一样。</p>
<p>谈一谈不一样的地方<br>小动物，商店道具，特产，称号，收藏品，入门和进阶的页面，我写到了一个页面中。<br>原本预想其实就是分成好几个Activity来写，但是后来想想写了那么多Activity其实参数都一样，逻辑也都一样，就是页面的布局不一样而已。<br>写那么多的Activity其实可以写成一个Activity，然后Adapter做抽象，实现不同的 Adapter来实现不同的列表。<br>后面又想了一下，Adapter其实也不用做什么操作，只有布局不一样，点击响应和数据传递都是一样的。就把布局直接传给了Adapter。由数据来确定初始化什么布局，和布局的样式。<br>最终实现就是这样，但是也看出了这样实现的一些弊端，就是不适合数据量大的场景。不过我们的数据量确实不大，就先这样了！！nice day!!</p>
<hr>
<p>就写到这里了。攻略也不想整理了！！！！  因为根本就找不到用户 2333！！</p>
<p><strong><em>By Xiaolong,每一天都值得被认真对待！</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2017/12/29/BluetoothForAndroid5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/29/BluetoothForAndroid5/" itemprop="url">
                  蓝牙协议学习整理（四）蓝牙协议规范（irOBEX、BNEP、AVDTP、AVCTP）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-29T17:53:27+08:00">
                2017-12-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android蓝牙/" itemprop="url" rel="index">
                    <span itemprop="name">Android蓝牙</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、IrDA互操作协议"><a href="#一、IrDA互操作协议" class="headerlink" title="一、IrDA互操作协议"></a>一、IrDA互操作协议</h3><p>IrOBEX 红外对象交互协议，简称OBEX，使高层协议同时运作在蓝牙和红外的无线链路之上。</p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229155728786.png?raw=true" alt="这里写图片描述"></p>
<p>主要操作指令有：连接操作、断开操作、Put操作、Get操作。</p>
<h4 id="1、连接操作-操作码0x80"><a href="#1、连接操作-操作码0x80" class="headerlink" title="1、连接操作 ,操作码0x80"></a>1、连接操作 ,操作码0x80</h4><table><tr><td>字节0</td><td>字节1、2</td><td>字节3</td><td>字节4</td><td>字节5、6</td><td>字节7～n</td></tr><tr><td>0x80</td><td>连接请求分组长度</td><td>OBEX版本号</td><td>标志</td><td>客户端可接收最大的OBEX分组长度</td><td>可选头</td></tr></table>

<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229155842107.png?raw=true" alt="这里写图片描述"></p>
<table><tr><td>字节0</td><td>字节1、2</td><td>字节3</td><td>字节4</td><td>字节5、6</td><td>字节7～n</td></tr><tr><td>0x80Connect命令</td><td>7</td><td>0x10</td><td>标志</td><td>65534</td><td>可选头</td></tr></table>

<p><strong>连接响应</strong><br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229155929503.png?raw=true" alt="1"></p>
<h4 id="2、断开操作"><a href="#2、断开操作" class="headerlink" title="2、断开操作"></a>2、断开操作</h4><p>操作码为0x81</p>
<h4 id="3、Put操作"><a href="#3、Put操作" class="headerlink" title="3、Put操作"></a>3、Put操作</h4><p>操作码为0x02</p>
<p>连接成功后，客户端通过Put请求向服务器“推送”对象，如果对象较大，Put请求可以用多个Put请求分组。</p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229160055997.png?raw=true" alt="这里写图片描述"></p>
<h4 id="4、Get操作"><a href="#4、Get操作" class="headerlink" title="4、Get操作"></a>4、Get操作</h4><p>操作码为0x03</p>
<h3 id="二、音频与电话控制协议"><a href="#二、音频与电话控制协议" class="headerlink" title="二、音频与电话控制协议"></a>二、音频与电话控制协议</h3><h4 id="1、框架部分"><a href="#1、框架部分" class="headerlink" title="1、框架部分"></a>1、框架部分</h4><p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229160153980.png?raw=true" alt="这里写图片描述"></p>
<p>蓝牙音频如上图协议栈所示：音频通过基带传输同步面向连接分组实现，没有以规范的形式给出，不是协议栈的一部分。<br>    TCS_Binary是一种基于分组电话控制二进制编码指令集，位于L2CAP之上。实现蓝牙无绳电话、对讲机功能。<br>    RFCOMM用于AT指令，拨号上网、蓝牙耳机、耳麦、传真通过AT发送指令控制。</p>
<h4 id="2、音频部分"><a href="#2、音频部分" class="headerlink" title="2、音频部分"></a>2、音频部分</h4><p>   64kbps电信级语言质量音频流<br>    CVSD  continuous variable slope delta 连续可变斜率增量。<br>    PCM  pulse code modulation 。<br>    PCM存在斜率效应。CVSD使用音节压缩算法，编码步长根据信号斜率变化自动调整，是现在比较好的编码方案，提高语言的抗干扰能力。</p>
<h4 id="3、电话控制部分"><a href="#3、电话控制部分" class="headerlink" title="3、电话控制部分"></a>3、电话控制部分</h4><pre><code>TCS-Binary电话控制部分。
</code></pre><p>（1）、电话呼叫</p>
<pre><code>呼叫控制、呼叫建立、呼叫拆除；
</code></pre><p>（2）、组管理</p>
<pre><code>访问权限请求、分布式配置、快速内部成员访问。
</code></pre><h3 id="三、网络封装协议-BNEP"><a href="#三、网络封装协议-BNEP" class="headerlink" title="三、网络封装协议  BNEP"></a>三、网络封装协议  BNEP</h3><p>BNEP BluetoothNetworkEncapsulation Protocol 网络封装协议。<br>    为了使集成蓝牙技术的电脑、电话、PDA、家用电器等网络设备交换信息，需要在网络层统一数据分组。网络封装协议将来自不同网络的数据分组重新封装，通过L2CAP进行传输。这部分协议感觉在现实中用处不大，有更多简单便捷的方法去实现网络功能。<br>    BNEP支持Ipv4、Ipv6、IPX</p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229160349916.png?raw=true" alt="这里写图片描述"></p>
<h3 id="四、音视频分发协议AVDTP"><a href="#四、音视频分发协议AVDTP" class="headerlink" title="四、音视频分发协议AVDTP"></a>四、音视频分发协议AVDTP</h3><p>AVDTPAudio/Video Distribution Transport Protocol音视频分发传输协议</p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229160422944.png?raw=true" alt="这里写图片描述"></p>
<p>有关A/V的协议 AVDTP音视频分发传输协议、AVCTP音视频控制传输协议、GAVDP通用音视频分发框架、A2DP高级音频分发框架、AVCRP音视频遥控框架</p>
<h4 id="1、基本概念术语"><a href="#1、基本概念术语" class="headerlink" title="1、基本概念术语"></a>1、基本概念术语</h4><p>流stream:流是音视频传输的数据形式，单向传输，在AVDTP中被分为媒介分组。流有句柄HS统一标识。</p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229160502080.png?raw=true" alt="这里写图片描述"></p>
<h4 id="2、信令"><a href="#2、信令" class="headerlink" title="2、信令"></a>2、信令</h4><p>AVDTP信令列表</p>
<table><tr><td>命令</td><td>信令标识符</td><td>描述</td></tr><tr><td>AVDTP_DISCOVER</td><td>0x01</td><td>发现设备中的流端点</td></tr><tr><td>AVDTP_GET_CAPABILITIES</td><td>0x02</td><td>获得流端点的信息能力</td></tr><tr><td>AVDTP_SET_CONFIGURATION</td><td>0x03</td><td>对SEP进行配置</td></tr><tr><td>AVDTP_GET_CONFIGURATION</td><td>0x04</td><td>获取SEP当前配置</td></tr><tr><td>AVDTP_RECONFIGURE</td><td>0x05</td><td>对SEP重新配置</td></tr><tr><td>AVDTP_OPEN</td><td>0x06</td><td>成功的配置SEP后，打开流</td></tr><tr><td>AVDTP_START</td><td>0x07</td><td>流被打开：用于开始形成流；流暂停时：用于重新形成流。</td></tr><tr><td>AVDTP_CLOSE</td><td>0x08</td><td>对SEP关闭</td></tr><tr><td>AVDTP_SUSPEND</td><td>0x09</td><td>请求SEP暂停</td></tr><tr><td>AVDTP_SECURITY_CONTROL</td><td>0x0A</td><td>设置设备内容保护、或者请求设备状况信息</td></tr><tr><td>AVDTP_ABORT</td><td>0x0B</td><td>中断正在建立或者传输的过程</td></tr><tr><td>AVDTP_GET_ALL_CAPABILITIES</td><td></td><td></td></tr><tr><td>AVDTP_DELAYREPORT</td><td></td><td></td></tr></table>

<pre><code>这部分信令，实现了蓝牙的A2DP 数据流的控制
</code></pre><p><strong>（1）、流的信令管理流程</strong></p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229160645996.png?raw=true" alt="这里写图片描述"></p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229160703608.png?raw=true" alt="这里写图片描述"></p>
<p><strong>（2）、get capabilities  获取支持特性</strong></p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229160738415.png?raw=true" alt="这里写图片描述"></p>
<p><strong>（3）、set configuration 配置音频参数</strong></p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229160806185.png?raw=true" alt="这里写图片描述"></p>
<p>其他指令类似去上面两个的操作。</p>
<h3 id="五、音视频控制传输协议AVCTP"><a href="#五、音视频控制传输协议AVCTP" class="headerlink" title="五、音视频控制传输协议AVCTP"></a>五、音视频控制传输协议AVCTP</h3><p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth Protocol4/20171229160834464.png?raw=true" alt="这里写图片描述"></p>
<p>AVCTP可以使音视频设备同时支持多个应用框架，每个应用框架定义了各自相应的消息格式与应用规则。</p>
<p>这部分操作，在现实的应用中也有不足的地方，蓝牙传输的数据量有限，实现这些功能有一定的不足。随着科学技术的发展，蓝牙在无线通信方面的优点、缺点都凸显出来，找的合适的方向，合理的发展方向是硬道理。</p>
<p>蓝牙芯片厂商：</p>
<p>CSR公司（Cambridge Silicon Radio）(目前最大的蓝牙芯片的全球供应商)</p>
<p>Broadcom公司</p>
<p>ISSC公司</p>
<p>TI公司 (CC2541)</p>
<p>MTK公司（MT6620）</p>
<p>传送门：</p>
<p><a href="http://xiaolongonly.cn/2017/11/01/BluetoothForAndroid2/" target="_blank" rel="external">（一）蓝牙的概述</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid3/" target="_blank" rel="external">（二）蓝牙协议规范（射频、基带链路控制、链路管理）</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid4/" target="_blank" rel="external">（三）蓝牙协议规范（HCI、L2CAP、SDP、RFOCMM）</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid5/" target="_blank" rel="external">（四）蓝牙协议规范（irOBEX、BNEP、AVDTP、AVCTP）</a></p>
<p><a href="http://blog.csdn.net/xubin341719" target="_blank" rel="external">引用自xubin的博客</a></p>
<p><strong><em>By Xiaolong,每一天都值得被认真对待！</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2017/12/29/BluetoothForAndroid4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/29/BluetoothForAndroid4/" itemprop="url">
                  蓝牙协议学习整理（三）蓝牙协议规范（HCI、L2CAP、SDP、RFOCMM）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-29T15:53:27+08:00">
                2017-12-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android蓝牙/" itemprop="url" rel="index">
                    <span itemprop="name">Android蓝牙</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="第三章-蓝牙协议规范（HCI、L2CAP、SDP、RFOCMM）"><a href="#第三章-蓝牙协议规范（HCI、L2CAP、SDP、RFOCMM）" class="headerlink" title="第三章 蓝牙协议规范（HCI、L2CAP、SDP、RFOCMM）"></a>第三章 蓝牙协议规范（HCI、L2CAP、SDP、RFOCMM）</h2><h3 id="一、主机控制接口协议-HCI"><a href="#一、主机控制接口协议-HCI" class="headerlink" title="一、主机控制接口协议  HCI"></a>一、主机控制接口协议  HCI</h3><p>蓝牙主机-主机控模型<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229144618138.png?raw=true" alt="这里写图片描述"></p>
<p>蓝牙软件协议栈堆的数据传输过程：<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229144652458.png?raw=true" alt="这里写图片描述"></p>
<h3 id="1、蓝牙控制器接口数据分组："><a href="#1、蓝牙控制器接口数据分组：" class="headerlink" title="1、蓝牙控制器接口数据分组："></a>1、蓝牙控制器接口数据分组：</h3><p>指令分组、事件分组、数据分组</p>
<p><strong>（1）、指令分组</strong><br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229144809764.png?raw=true" alt="这里写图片描述"></p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229144827809.png?raw=true" alt="这里写图片描述"></p>
<p>如：Accpet Connection Request</p>
<ul>
<li>Opcode为：0x0409</li>
<li>参数长度为: 07 </li>
<li>参数中蓝牙地址为：00:0d:fd:5f:16:9f    </li>
<li>角色为：从设备  0x01</li>
</ul>
<p>大端数据模式</p>
<ul>
<li>指令为：09 04 07 9f 16 5f fd 0d 00 01</li>
</ul>
<p><strong>（2）、事件分组</strong><br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229144950189.png?raw=true" alt="这里写图片描述"></p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229145133698.png?raw=true" alt="这里写图片描述"><br>如上图：</p>
<ul>
<li>Opcode :0x0409</li>
<li>状态： 0x00</li>
<li>总长度： 4字节</li>
<li>命令状态：0x0f</li>
</ul>
<p><strong>（3）、数据分组</strong><br>ACL 数据分组</p>
<table><tr><td>连接句柄（12bit）</td><td>PB(2bit)</td><td>BC(2bit)</td><td>数据长度（16bit）</td></tr><tr><tdcolspan=4>数据…………</tdcolspan=4></tr></table>

<pre><code>注：PB  Packet_Boundary  BC Broadcast Flag
</code></pre><p>SCO 数据分组</p>
<table><tr><td>连接句柄（12bit）</td><td>PB(2bit)</td><td>BC(2bit)</td><td>数据长度（16bit）</td></tr><tr><tdcolspan=4>数据…………</tdcolspan=4></tr></table>

<p><strong>（4）、RS232分组指示器:</strong></p>
<table><tr><td>HCI分组类型</td><td>RS232分组指示器</td></tr><tr><td>HCI指令分组</td><td>0x01</td></tr><tr><td>HCIACL数据分组</td><td>0x02</td></tr><tr><td>HCISCO数据分组</td><td>0x03</td></tr><tr><td>HCI事件分组</td><td>0x04</td></tr><tr><td>HCI错误消息分组</td><td>0x05</td></tr><tr><td>HCI协商分组</td><td>0x06</td></tr></table><br>#### 2、HCI控制命令<br><br><strong>（1）、链路控制指令</strong><br><br><table><tr><td>命令</td><td>OCF</td><td>概述</td></tr><tr><td>Inquiry</td><td>0x0001</td><td>蓝牙设备进入查询模式，搜索临近设备</td></tr><tr><td>InquiryCancel</td><td>0x0002</td><td>退出查询模式</td></tr><tr><td>PeriodicInquiryMode</td><td>0x0003</td><td>蓝牙设备在指定周期内自动查询</td></tr><tr><td>ExitPeriodicInquiryMode</td><td>0x0004</td><td>退出自动查询模式</td></tr><tr><td>CreateConnection</td><td>0x0005</td><td>按指定蓝牙设备的BD_ADDR创建ACL链路</td></tr><tr><td>Disconnect</td><td>0x0006</td><td>终止现有连接</td></tr><tr><td>AddSCOConnection</td><td>0x0007</td><td>利用连接句柄参数指定的ACL连接创建SCO</td></tr><tr><td>CancelCreateConnection</td><td>0x0008</td><td></td></tr><tr><td>AcceptConnectionRequest</td><td>0x0009</td><td>接收新的呼入连接请求</td></tr><tr><td>RejectConnectionRequest</td><td>0x000A</td><td>拒绝新的呼入连接请求</td></tr><tr><td>LinkKeyRequestReply</td><td>0x000B</td><td>应答从主机控制器发出的链路密钥请求事件，并指定存储在主机上的链路密钥做为与BD_ADDR指定的蓝牙设备进行连接使用的链路密钥请求事件</td></tr><tr><td>LinkKeyRequestNegativeReply</td><td>0x000C</td><td>如果主机上没有存储链路密钥，作为与BD_ADDR指定的蓝牙设备进行连接使用的链路密钥，就应答从主机控制器发出的链路密钥请求事件</td></tr><tr><td>PINCodeRequestReply</td><td>0x000D</td><td>应答从主机控制器发出的PIN请求事件，并指定用于连接的PIN</td></tr><tr><td>PINCodeRequestNegativeReply</td><td>0x000E</td><td>当主机不能指定连接的PIN时，应回答从机控制器发出的PIN请求事件</td></tr><tr><td>ChangeConnectionPacketType</td><td>0x000F</td><td>改变正在建立连接的分组类型</td></tr><tr><td>AuthenticationRequest</td><td>0x0011</td><td>指定连接句柄关联的两个蓝牙设备之间建立身份鉴权</td></tr><tr><td>SetConnectionEncryption</td><td>0x0013</td><td>建立取消连接加密</td></tr><tr><td>ChangeConnectionLinkKey</td><td>0x0015</td><td>强制关联了连接句柄的两个设备建立连接，并生成一个新的链路密钥</td></tr><tr><td>MasterLinkKey</td><td>0x0017</td><td>强制关联了连接句柄的两个设备利用主设备时链路密钥或常规密钥</td></tr><tr><td>RemoteNameRequest</td><td>0x0019</td><td>获取远端设备的名称</td></tr><tr><td>CancelRemoteNameRequest</td><td></td><td></td></tr><tr><td>ReadRemoteSupportedFeatures</td><td>0x001B</td><td>请求远端设备所支持的特性列表</td></tr><tr><td>ReadRemoteExtendedFeatures</td><td></td><td></td></tr><tr><td>ReadRemoteVersionInformation</td><td>0x001D</td><td>从远端设备读取版本信息</td></tr><tr><td>ReadClockOffset</td><td>0x001F</td><td>读取远端的时钟信息</td></tr></table>

<p><strong>（2）、链路策略指令</strong></p>
<table><tr><td>命令</td><td>OCF</td><td>简介</td></tr><tr><td>HoldMode</td><td>0x0001</td><td>改变LM状态和本地及远程设备为主模式的LM位置</td></tr><tr><td>SniffMode</td><td>0x0003</td><td>改变LM状态和本地及远程设备为呼吸模式的LM位置</td></tr><tr><td>ExitSniffMode</td><td>0x0004</td><td>结束连接句柄在当前呼吸模式里的呼吸模式</td></tr><tr><td>ParkState</td><td>0x0005</td><td>改变LM状态和本地及远程设备为休眠模式的LM位置</td></tr><tr><td>ExitParkState</td><td>0x0006</td><td>切换从休眠模式返回到激活模式的蓝牙设备</td></tr><tr><td>QoSSetup</td><td>0x0007</td><td>指出连接句柄的服务质量参数</td></tr><tr><td>RoleDiscovery</td><td>0x0009</td><td>蓝牙设备连接后确定自己的主从角色</td></tr><tr><td>SwitchRole</td><td>0x000B</td><td>角色互换</td></tr><tr><td>ReadLinkPolicySettings</td><td>0x000C</td><td>为指定连接句柄读链路策略设置。链路策略设置允许主机控制器指定用于连接句柄的LM连接模式</td></tr><tr><td>WriteLinkPolicySettings</td><td>0x000D</td><td>为指定连接句柄写链路策略设置。链路策略设置允许主机控制器指定用于连接句柄的LM连接模式</td></tr><tr><td>ReadDefaultLinkPolicySettings</td><td>0x000E</td><td></td></tr><tr><td>WriteDefaultLinkPolicySettings</td><td>0x000F</td><td></td></tr><tr><td>FlowSpecification</td><td>0X0010</td><td></td></tr></table>

<p><strong>（3）、主机控制器与基带指令</strong></p>
<table><tr><td>SetEventMark</td><td>0x0001</td><td>使能主机过滤HCI产生的事件</td></tr><tr><td>Reset</td><td>0x0003</td><td>复位蓝牙控制器、链路管理器、基带链路管理器</td></tr><tr><td>SetEventFilter</td><td>0x0005</td><td>使能主机指定不同事件过滤</td></tr><tr><td>Flush</td><td>0x0008</td><td>针对指定的蓝牙句柄，放弃所有作为当前待传输数据，甚至当前是属于多个在主机控制器里的L2CAP指令的数据块</td></tr><tr><td>ReadPINType</td><td>0x0009</td><td>主机读取指定主机的PIN类型是可变的还是固定的</td></tr><tr><td>WritePINType</td><td>0x000A</td><td>主机写入指定主机的PIN类型是可变的还是固定的</td></tr><tr><td>CreateNewUnitKey</td><td>0x000B</td><td>创建新的单一密钥</td></tr><tr><td>ReadStoredLinkKey</td><td>0x000D</td><td>读取存放在蓝牙控制器中的单个或者多个密钥</td></tr><tr><td>WriteStoredLinkKey</td><td>0x0011</td><td>写入存放在蓝牙控制器中的单个或者多个密钥</td></tr><tr><td>DeleteStoredLinkKey</td><td>0x0012</td><td>删除存放在蓝牙控制器中的单个或者多个密钥</td></tr><tr><td>WriteLocalName</td><td>0x0013</td><td>修改蓝牙设备名称</td></tr><tr><td>ReadLocalName</td><td>0x0014</td><td>读取蓝牙设备名称</td></tr><tr><td>ReadConnectionAcceptTimeout</td><td>0x0015</td><td>读连接识别超时参数值，定时器终止后蓝牙硬件自动拒绝连接</td></tr><tr><td>WriteConnectionAcceptTimeout</td><td>0x0016</td><td>写连接识别超时参数值，定时器终止后蓝牙硬件自动拒绝连接</td></tr><tr><td>ReadPageTimeout</td><td>0x0017</td><td>读寻呼超时参数值，本地设备返回连接失败前，该值是允许蓝牙硬件定义等待远程设备连接申请时间</td></tr><tr><td>WritePageTimeout</td><td>0x0018</td><td>写寻呼超时参数值，本地设备返回连接失败前，该值是允许蓝牙硬件定义等待远程设备连接申请时间</td></tr><tr><td>ReadScanEnable</td><td>0x0019</td><td>写出扫描允许参数值—用来控制蓝牙设备周期性查询</td></tr><tr><td>WriteScanEnable</td><td>0x001A</td><td>读出扫描允许参数值—用来控制蓝牙设备周期性查询</td></tr><tr><td>ReadPageScanActivity</td><td>0x001B</td><td>读寻呼扫描间隔、寻呼扫描区间参数</td></tr><tr><td>WritePageScanActivity</td><td>0x001C</td><td>写寻呼扫描间隔、寻呼扫描区间参数</td></tr><tr><td>ReadInquiryScanActivity</td><td>0x001D</td><td>读查询扫描间隔、查询扫描区间参数</td></tr><tr><td>WriteInquiryScanActivity</td><td>0x001E</td><td>写查询扫描间隔、查询扫描区间参数</td></tr><tr><td>ReadAuthenticationEnable</td><td>0x001F</td><td>读取鉴权允许参数—控制蓝牙设备是否对每个连接进行鉴权</td></tr><tr><td>WriteAuthenticationEnable</td><td>0x0020</td><td>写取鉴权允许参数—控制蓝牙设备是否对每个连接进行鉴权</td></tr><tr><td>ReadEncryptionMode</td><td>0x0021</td><td>读加密模式数值—控制蓝牙设备是否对每个连接进行加密</td></tr><tr><td>WriteEncryptionMode</td><td>0x0022</td><td>写加密模式数值—控制蓝牙设备是否对每个连接进行加密</td></tr><tr><td>ReadClassOfDevice</td><td>0x0023</td><td>读取设备类型参数值，用于区别设备能力</td></tr><tr><td>WriteClassOfDevice</td><td>0x0024</td><td>写设备类型参数值，用于区别设备能力</td></tr><tr><td>ReadVoiceSetting</td><td>0x0025</td><td>读取语音设置参数值，控制语音连接的各种设置</td></tr><tr><td>WriteVoiceSetting</td><td>0x0026</td><td>写语音设置参数值，控制语音连接的各种设置</td></tr><tr><td>ReadAutomaticFlushTimeout</td><td>0x0027</td><td>对指定句柄，读取刷新超时值</td></tr><tr><td>WriteAutomaticFlushTimeout</td><td>0x0028</td><td>对指定句柄，写入刷新超时值</td></tr><tr><td>ReadNumBroadcastRetransmissions</td><td>0x0029</td><td>读取设备的广播重复发送次数，重复发送提高广播消息的可靠性</td></tr><tr><td>WriteNumBroadcastRetransmissions</td><td>0x002A</td><td>写入设备的广播重复发送次数，重复发送提高广播消息的可靠性</td></tr><tr><td>ReadHoldModeActivity</td><td>0x002B</td><td>读取HoldModeActivity的参数值，用来确定Hold挂起的时间</td></tr><tr><td>WriteHoldModeActivity</td><td>0x002C</td><td>写入HoldModeActivity的参数值，用来确定Hold挂起的时间</td></tr><tr><td>ReadTransmitPowerLevel</td><td>0x002D</td><td>对指定句柄，读取传输功率的参数值</td></tr><tr><td>ReadSynchronousFlowControlEnable</td><td>0x002E</td><td>读取SCO流量控制设置。通过使用该设置，主机控制器决定是否主机控制器发送与SCO连接句柄相关的完成分组事件的数量</td></tr><tr><td>WriteSynchronousFlowControlEnable</td><td>0x002F</td><td>读写入SCO流量控制设置。通过使用该设置，主机控制器决定是否主机控制器发送与SCO连接句柄相关的完成分组事件的数量</td></tr><tr><td>SetHostControllerToHostFlowControl</td><td>0x0031</td><td>主机控制器的打开、关闭，主机控制器到主机的流量控制</td></tr><tr><td>HostBufferSize</td><td>0x0033</td><td>主机通知主机控制器自己的ACL、SCO数据缓冲区大小。主机控制器分段传输数据，而数据不会超出这个范围</td></tr><tr><td>HostNumberOfCompletedPackets</td><td>0x0035</td><td>当主机对于任何连接的句柄准备接受较多的HCI指令时，该指令用于通过主机指出主机控制器</td></tr><tr><td>ReadLinkSupervisionTimeout</td><td>0x0036</td><td>读取连接管理超时参数。主从蓝牙设备用该参数监视链路丢失情况</td></tr><tr><td>WriteLinkSupervisionTimeout</td><td>0x0037</td><td>写入连接管理超时参数。主从蓝牙设备用该参数监视链路丢失情况</td></tr><tr><td>ReadNumberofSupportedIAC</td><td>0x0038</td><td>读取查询扫描期间本地蓝牙扫描的查询识别码（ICA）的数值</td></tr><tr><td>ReadCurrentIACLAP</td><td>0x0039</td><td>读取创建在查询扫描期间本地蓝牙设备正同时扫描的蓝牙识别码的LAP</td></tr><tr><td>WriteCurrentIACLAP</td><td>0x003A</td><td>写入创建在查询扫描期间本地蓝牙设备正同时扫描的蓝牙识别码的LAP</td></tr><tr><td>ReadPageScanPeriodMode</td><td>0x003B</td><td>读取本地蓝牙设备的强制寻呼扫描区间模式</td></tr><tr><td>WritePageScanPeriodMode</td><td>0x003C</td><td>写入本地蓝牙设备的强制寻呼扫描区间模式</td></tr><tr><td>ReadPageScanMode</td><td>0x003D</td><td>读取本地蓝牙设备的默认寻呼扫描区间模式</td></tr><tr><td>WritePageScanMode</td><td>0x003E</td><td>写入本地蓝牙设备的默认寻呼扫描区间模式</td></tr></table>

<p><strong>（4）、信息指令参数</strong></p>
<table><tr><td>ReadLocalVersionInformation</td><td>0x0001</td><td>读取本地蓝牙版本信息</td></tr><tr><td>ReadLocalSupportedFeatures</td><td>0x0003</td><td>读取本地蓝牙设备特征表</td></tr><tr><td>ReadLocalExtendedFeatures</td><td>0x0004</td><td></td></tr><tr><td>ReadBufferSize</td><td>0x0005</td><td>返回HCI缓冲容量。缓冲容量用于传输缓冲数据</td></tr><tr><td>ReadCountryCode[Deprecated]</td><td>0x0007</td><td>读取国家代码状态参数值</td></tr><tr><td>ReadBDADDR</td><td>0x0009</td><td>读取BD_ADDR的参数值</td></tr></table><br><strong>（5）、状态指令参数</strong><br><table><tr><td>ReadFailedContactCount</td><td>0x0001</td><td>读取对于其他设备特殊连接的FailedContactCount参数值。FailedContactCount记录在刷新时终止及当前正在传输的L2CAP数据指令被自动刷新后，主单元或从单元不能连续响应事件次数</td></tr><tr><td>ResetFailedContactCount</td><td>0x0002</td><td>复位时对于其他设备的连接的FailedContactCount的参数值。FailedContactCount记录在刷新时终止及当前正在传输的L2CAP数据指令被自动刷新后，主单元或从单元不能连续响应事件次数</td></tr><tr><td>GetLinkQuality</td><td>0x0003</td><td>读取指定连接句柄的LinkQuality的值</td></tr><tr><td>ReadRSSI</td><td>0x0005</td><td>读取对于其他蓝牙设备连接句柄的接收信号强度指示</td></tr><tr><td>ReadAFHChannelMap</td><td>0x0007</td><td></td></tr><tr><td>ReadBDClock</td><td>0x0009</td><td></td></tr></table><br><strong>（6）、测试指令</strong><br><table><tr><td>ReadLoopbackMode</td><td>0x0001</td><td>读取主机端控制器会送模式的设置值。回送模式设置可以确定信息发送路径</td></tr><tr><td>WriteLoopbackMode</td><td>0x0002</td><td>写入主机控制器会送模式的设置值。回送模式设置可以确定信息发送路径</td></tr><tr><td>EnableDeviceUnderTestMode</td><td>0x0003</td><td>允许本地蓝牙设备模块通过LMP测试指令接入测试模式。当主机要求本地设备作为待测试设备，实现蓝牙测试模式文件中规定测试场景，则发送该指令</td></tr></table>

<p><strong>（7）、错误代码</strong></p>
<table><tr><td>错误代码</td><td>错误含义</td><td>错误代码</td><td>错误含义</td></tr><tr><td>0x01</td><td>位置HCI指令</td><td>0x14</td><td>由于另一端引起连接中断：资源限制</td></tr><tr><td>0x02</td><td>不能连接</td><td>0x15</td><td>由于另一端引起连接中断：关机</td></tr><tr><td>0x03</td><td>硬件故障</td><td>0x16</td><td>本机中断连接</td></tr><tr><td>0x04</td><td>寻呼超时</td><td>0x17</td><td>重复尝试</td></tr><tr><td>0x05</td><td>身份验证失败</td><td>0x18</td><td>不允许匹配</td></tr><tr><td>0x06</td><td>键丢失</td><td>0x19</td><td>未知LMPPDU</td></tr><tr><td>0x07</td><td>存储器已满</td><td>0x1A</td><td>不支持远端特性</td></tr><tr><td>0x08</td><td>连接超时</td><td>0x1B</td><td>拒绝SCO补偿</td></tr><tr><td>0x09</td><td>最大连接数</td><td>0x1C</td><td>拒绝SCO间歇模式</td></tr><tr><td>0x0A</td><td>连接到设备A的最大SCO连接数</td><td>0x1D</td><td>拒绝SCO无线模式</td></tr><tr><td>0x0B</td><td>ACL连接已存在</td><td>0x1E</td><td>非法链路管理参数</td></tr><tr><td>0x0C</td><td>指令非法</td><td>0x1F</td><td>未特别指明错误</td></tr><tr><td>0x0D</td><td>由于资源有限，主机被拒绝</td><td>0x20</td><td>不支持链路管理器协议参数</td></tr><tr><td>0x0E</td><td>由于安全原因，主机被拒绝</td><td>0x21</td><td>不允许角色改变</td></tr><tr><td>0x0F</td><td>由于远端设备单连接设备，主机拒绝</td><td>0x22</td><td>链路管理响应超时</td></tr><tr><td>0x10</td><td>主机超时</td><td>0x23</td><td>链路管理错误处理事务冲突</td></tr><tr><td>0x11</td><td>不支持特性或参数值</td><td>0x24</td><td>不允许LMPPDU</td></tr><tr><td>0x12</td><td>非法主机控制接口指令</td><td>0x25~0xFF</td><td>保留</td></tr><tr><td>0x13</td><td>由于另一端引起连接中断：用户中断连接</td><td></td><td></td></tr></table>

<h3 id="二、逻辑链路控制与适配协议-L2CAP"><a href="#二、逻辑链路控制与适配协议-L2CAP" class="headerlink" title="二、逻辑链路控制与适配协议  L2CAP"></a>二、逻辑链路控制与适配协议  L2CAP</h3><p>L2CAP位于基带之上，将基带的数据分组转换为便于高层应用的数据分组格式，并提供协议复用和服务质量交换等功能。L2CAP只支持ACL数据传输，不支持SCO数据。</p>
<p>L2CAP本身不提供加强信道可靠性和保证数据完整性的机制，其信道的可靠性依靠基带提供。</p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229150912346.png?raw=true" alt="这里写代码片"></p>
<h4 id="1、协议复用："><a href="#1、协议复用：" class="headerlink" title="1、协议复用："></a>1、协议复用：</h4><p>底层传输协议没有提供对高层协议的复用机制，因而L2CAP支持高层协议复用，L2CAP层可以区分其上的SDP、RFCOMM、TCS等。</p>
<h3 id="2、分段重组："><a href="#2、分段重组：" class="headerlink" title="2、分段重组："></a>2、分段重组：</h3><p>L2CAP层帮助实现基带的短PDU和高层的长PDU相互传输，L2CAP本身不完成任何PDU的分段重组，具体的分段重组有低层和高层来完成。</p>
<h3 id="3、服务质量"><a href="#3、服务质量" class="headerlink" title="3、服务质量"></a>3、服务质量</h3><p>Qualityof Serivce 信息的交换：蓝牙建立连接的过程中，L2CAP允许交互蓝牙所期望的服务质量，建立完成后，通过监视资源的使用情况，来保证服务质量。</p>
<p>###4、组抽象：</p>
<p>L2CAP忽略地址组概念，他只关心数据。<br>    L2CAP信道有三种类型：<br>        <strong>A、面向连接信道：</strong>Connection-OrientedCO，用于两个设备之间的数据通信。<br>        <strong>B、无连接信道：</strong>Connection-LessCL，用来向一组设备广播方式传输数据。CID为固定值：0x0002。<br>        <strong>C、信令信道：</strong>Signaling，用于创建CO通道，可以通过协商改变CO信道的特性。<br>CL信道的L2CAP_PDU</p>
<table><tr><td>长度（2bytes）</td><td>信道ID（0x0002）</td><td>PSM(最小为2bytes)</td><td>有效载荷</td></tr></table>

<p>PSM为 协议/服务复用器Protocol/Service Multiplexer，一般为SDP、RFCOMM、TCS等中介协议复用。小于0x1000的值，0x0001对应SDP，0x0003对应RFCOMM、0x0005对应TCS。</p>
<p><strong>（1）、蓝牙逻辑链路控制与适配协议信令：</strong><br>    L2CAP的信令通道的CID为0x0001<br>    <strong>信令指令分组：</strong></p>
<table><tr><td>长度（2byte）</td><td>CID(0x0001)</td><td>指令1</td><td>指令2</td><td>……………</td><td>指令n</td></tr><tr><tdcolspan=2>L2CAP分组头部分<tdcolspan=4></tdcolspan=4></tdcolspan=2></tr></table>

<p><strong>信令指令格式：</strong></p>
<table><tr><td>代码（1byte）</td><td>标识符（1byte）</td><td>长度(2byte)</td><td>数据</td></tr><tr><tdcolspan=4>信令指令头</tdcolspan=4></tr></table>

<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229151442563.png?raw=true" alt="这里写图片描述"></p>
<p>如上图所示，一条L2CAP信令，1为L2CAP分组头，2为信令指令头，3为数据部分。</p>
<p>L2CAP:<br>         Role:Master<br>         Address:11<br>         PDULength: 6  //指令的长度，值为06 00<br>         ChannelID: 0x0001  (Signaling)//L2CAP的信令通道，值为01 00<br>         Code:Information request//信息请求，值为0a<br>         Identifier:1//标识符，值为01<br>         CommandLength: 2//命令长度，值为02 00<br>         InfoType:Extended features supported//02 00<br>所以这条指令完整的为：<br>06 00 01 00 0a 01 02 00 02 00</p>
<p><strong>信令的其他操作如下：</strong><br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229151535240.png?raw=true" alt="这里写图片描述"></p>
<p><strong>L2CAP信令指令码：</strong></p>
<table><tr><td>Code</td><td>Description</td><td></td></tr><tr><td>0x00</td><td>RESERVED</td><td>保留</td></tr><tr><td>0x01</td><td>Commandreject</td><td>拒绝命令</td></tr><tr><td>0x02</td><td>Connectionrequest</td><td>连接请求</td></tr><tr><td>0x03</td><td>Connectionresponse</td><td>连接响应</td></tr><tr><td>0x04</td><td>Configurerequest</td><td>配置请求</td></tr><tr><td>0x05</td><td>Configureresponse</td><td>配置响应</td></tr><tr><td>0x06</td><td>Disconnectionrequest</td><td>断开请求</td></tr><tr><td>0x07</td><td>Disconnectionresponse</td><td>断开响应</td></tr><tr><td>0x08</td><td>Echorequest</td><td></td></tr><tr><td>0x09</td><td>Echoresponse</td><td></td></tr><tr><td>0x0A</td><td>Informationrequest</td><td>信息请求</td></tr><tr><td>0x0B</td><td>Informationresponse</td><td>信息响应</td></tr></table>

<p>1）、连接请求Connection_Request Code=0x02</p>
<table><tr><td>代码（0x02）</td><td>标识符（1字节）</td><td>长度（2字节）</td><td>PSM（2字节）</td><td>源CID（2字节）</td></tr></table><br>例如：SDP 连接请求<br><br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229151712043.png?raw=true" alt="这里写图片描述"><br><br>如上红框所示：<br><table><tr><td>代码（0x02）</td><td>标识符（1字节）</td><td>长度（2字节）</td><td>PSM（2字节）</td><td>源CID（2字节）</td></tr><tr><td>0x02</td><td>3</td><td>4</td><td>SDP</td><td>0x0040</td></tr></table>2）、连接相应Connection_ResponseCode=0x03<table><tr><td>代码（0x03）</td><td>标识符</td><td>长度</td><td>目标CID</td><td>源CID</td><td>结果</td><td>状态</td></tr></table><br>例如：SDP请求响应<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229151924175.png?raw=true" alt="这里写图片描述"><br>如上面红框所示：<br><table><tr><td>代码（0x03）</td><td>标识符</td><td>长度</td><td>目标CID</td><td>源CID</td><td>结果</td><td>状态</td></tr><tr><td>0x03</td><td>3</td><td>8</td><td>0x0040</td><td>0x0040</td><td>0x0000</td><td></td></tr></table>

<p><strong>（2）、MTU MAXIMUMTRANSMISSION UNIT最大传输单元 </strong></p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229152051005.png?raw=true" alt=""></p>
<p>MTU最大传输单元，L2CAP应用必须支持最小为48字节的MTU，默认值为672<br><strong>（3）、QoS 服务质量</strong></p>
<h3 id="三、服务发现协议SDP"><a href="#三、服务发现协议SDP" class="headerlink" title="三、服务发现协议SDP"></a>三、服务发现协议SDP</h3><p>SDP两种服务发现模式：<br>    <strong>1）、服务搜索：</strong>查询具有特定服务属性的服务；<br>    <strong>2）、服务浏览：</strong>简单的浏览全部可用服务。</p>
<h4 id="1-、PDU-格式：（协议数据单元）"><a href="#1-、PDU-格式：（协议数据单元）" class="headerlink" title="1 、PDU 格式：（协议数据单元）"></a>1 、PDU 格式：（协议数据单元）</h4><table><tr><td>PDUID（1byte）</td><td>TransactionID（2byte）</td><td>参数长度（2byte）</td><td>参数1</td><td>……</td><td>参数N</td></tr><tr><tdcolspan=3>Header<tdcolspan=3></tdcolspan=3></tdcolspan=3></tr></table>

<p>不同PDU ID实现SDP的不同功能，概述如下表格：</p>
<table><tr><td>Value</td><td>ParameterDescirption</td><td></td></tr><tr><td>0x00</td><td>Reserved</td><td>保留</td></tr><tr><td>0x01</td><td>SDP_ErrorResponse</td><td>错误响应</td></tr><tr><td>0x02</td><td>SDP_ServiceSearchRequest</td><td>服务搜索请求</td></tr><tr><td>0x03</td><td>SDP_ServiceSearchResponse</td><td>服务搜索响应</td></tr><tr><td>0x04</td><td>SDP_ServiceAttributeRequest</td><td>服务属性请求</td></tr><tr><td>0x05</td><td>SDP_ServiceAttributeResponse</td><td>服务属性响应</td></tr><tr><td>0x06</td><td>SDP_ServiceSearchAttributeRequest</td><td>服务搜索属性请求</td></tr><tr><td>0x07</td><td>SDP_ServiceSearchAttributeResponse</td><td>服务搜索属性响应</td></tr><tr><td>0x08-0xff</td><td>Reserved</td><td>保留</td></tr></table>

<h3 id="2、服务记录表"><a href="#2、服务记录表" class="headerlink" title="2、服务记录表"></a>2、服务记录表</h3><p>SDP的服务记录表对每一个服务进行描述，每条记录包含服务句柄、一组服务属性：<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229154027505.png?raw=true" alt="这里写图片描述"></p>
<ul>
<li>Service Record Attributes：服务记录；</li>
<li>Service Record Handle 服务句柄；</li>
</ul>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229154104731.png?raw=true" alt="这里写图片描述"></p>
<p>四、串口仿真协议   RFCOMM</p>
<p>为建立在串口之上的传统应用提供环境接口，使他们可以做比较少协议改动就可以在蓝牙无线通信无线链路上工作。多路串口仿真是RFCOMM的重要功能，通过多路复用器(multiplexer)，一条L2CAP链路可以同时 多个串行应用。<br>    两台设备间的串口仿真:<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229154137723.png?raw=true" alt="这里写图片描述"></p>
<p>RFCOMM 两个蓝牙设备之间可以支持多达60多路仿真串口。</p>
<p><strong>RFCOMM帧类型如下：</strong></p>
<table><tr><td>SABM</td><td>异步平衡模式设置指令</td></tr><tr><td>UA</td><td>未加编号的确认响应</td></tr><tr><td>DM</td><td>断开连接模式响应</td></tr><tr><td>DISC</td><td>断开连接指令</td></tr><tr><td>UIH</td><td>带头校验的未编号信息命令和响应</td></tr></table>

<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol3/20171229154247445.png?raw=true" alt="这里写图片描述"><br>传送门：<br><a href="http://xiaolongonly.cn/2017/11/01/BluetoothForAndroid2/" target="_blank" rel="external">（一）蓝牙的概述</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid3/" target="_blank" rel="external">（二）蓝牙协议规范（射频、基带链路控制、链路管理）</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid4/" target="_blank" rel="external">（三）蓝牙协议规范（HCI、L2CAP、SDP、RFOCMM）</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid5/" target="_blank" rel="external">（四）蓝牙协议规范（irOBEX、BNEP、AVDTP、AVCTP）</a></p>
<p><a href="http://blog.csdn.net/xubin341719" target="_blank" rel="external">引用自xubin的博客</a></p>
<p><strong><em>By Xiaolong,每一天都值得被认真对待！</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2017/12/29/BluetoothForAndroid3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/29/BluetoothForAndroid3/" itemprop="url">
                  蓝牙协议学习整理（二）蓝牙协议规范（射频、基带链路控制、链路管理）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-29T15:49:56+08:00">
                2017-12-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android蓝牙/" itemprop="url" rel="index">
                    <span itemprop="name">Android蓝牙</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="第二章-蓝牙协议规范（射频、基带链路控制、链路管理）"><a href="#第二章-蓝牙协议规范（射频、基带链路控制、链路管理）" class="headerlink" title="第二章 蓝牙协议规范（射频、基带链路控制、链路管理）"></a>第二章 蓝牙协议规范（射频、基带链路控制、链路管理）</h2><p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229114644415.png?raw=true" alt="这里写图片描述"></p>
<p>蓝牙协议是蓝牙设备间交换信息所应该遵守的规则。与开放系统互联（OSI）模型一样，蓝牙技术的协议体系也采用了分层结构，从底层到高层形成了蓝牙协议栈，各层协议定义了所完成的功能和使用数据分组格式，以保证蓝牙产品间的互操作性。</p>
<h3 id="一、射频协议"><a href="#一、射频协议" class="headerlink" title="一、射频协议"></a>一、射频协议</h3><p>射频位置如上图红色部分。</p>
<h4 id="1、工作频率"><a href="#1、工作频率" class="headerlink" title="1、工作频率"></a>1、工作频率</h4><p>蓝牙工作在2.4GHz ISM频段上，蓝牙采用跳频扩谱技术主动的避免工作频段受干扰（微波炉的工作频率也是2.4GHz）。<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229114755376.png?raw=true" alt="这里写图片描述"><br>|    地理位置        |    ISM频段范围    |    射频信道频率    |<br>|—————|—————|———–|<br>|中国、美国、欧洲    |2400.0～2483.5MHz|F=(2402+k)MHz,k在0、1、……78中随机取值|<br>|    法国            |2446.5～2483.5MHz|F=(2454+k)MHz,k在0、1、……22中随机取值|<br>|    日本            |2471.0～2497.0MHz|F=(2473+k)MHz,k在0、1、……22中随机取值|<br>|    西班牙        |2445.0～2475.0MHz|F=(2449+k)MHz,k在0、1、……22中随机取值|</p>
<p>我国的蓝牙频率在2.402GHz～2.483GHz,蓝牙每个频道的宽度为1MHz，为了减少带外辐射的干扰，保留上、下保护为3.5MHz和2MHz，79个跳频点中至少75个伪随机码跳动，30S内任何一个频点使用时长不能超过0.4S。</p>
<h4 id="2、跳频技术、发射功率、时隙"><a href="#2、跳频技术、发射功率、时隙" class="headerlink" title="2、跳频技术、发射功率、时隙"></a>2、跳频技术、发射功率、时隙</h4><p><strong>（1）、发射功率：</strong>蓝牙发射功率分三级：一级功率100mW(20dBm)；二级功率2.5mW(4dBm)；三级功率1mW(0dBm)；<br><strong>（2）、物理信道：</strong>蓝牙物理信道有伪随机序列控制的79个跳频点构成，不同跳频序列代表不同的信道。<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229115505075.png?raw=true" alt="这里写图片描述"></p>
<p><strong>（3）、时隙：</strong>蓝牙跳频速率为1600次/s,每个时间为625uS(1S/1600)称为一个时隙；<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229115555374.png?raw=true" alt="这里写图片描述"></p>
<h3 id="二、基带与链路控制协议"><a href="#二、基带与链路控制协议" class="headerlink" title="二、基带与链路控制协议"></a>二、基带与链路控制协议</h3><p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229115905108.png?raw=true" alt="这里写图片描述"></p>
<p>蓝牙发送数据时，基带部分将来自高层的数据进行信道编码，向下发给射频进行发送；接收数据时，将解调恢复空中数据并上传给基带，基带进行信道编码传送给上层。</p>
<p>作用：跳频选择、蓝牙编址、链路类型、信道编码、收发规则、信道控制、音频规范、安全设置。</p>
<h4 id="1、蓝牙分组编码为小端模式；"><a href="#1、蓝牙分组编码为小端模式；" class="headerlink" title="1、蓝牙分组编码为小端模式；"></a>1、蓝牙分组编码为小端模式；</h4><h4 id="2、蓝牙地址"><a href="#2、蓝牙地址" class="headerlink" title="2、蓝牙地址"></a>2、蓝牙地址</h4><ul>
<li><strong>BD_ADDR：</strong>BluetoothDevice Address；</li>
<li><strong>LAP:</strong>LowerAddress Part 低地址部分；</li>
<li><strong>UAP:</strong> UpperAddress Part 高地址部分；</li>
<li><strong>NAP:</strong> Non-significantAddress Part 无效地址部分。</li>
</ul>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229120127670.png?raw=true" alt="这里写图片描述"></p>
<p>3、蓝牙时钟</p>
<p>每个蓝牙设备都有一个独立运行的内部系统时钟，称为本地时钟（Local Clock），决定定时器的收发跳频。为了与其他设备同步，本地时钟要加一个偏移量（offset），提供给其他设备同步。</p>
<p>蓝牙基带四个关键周期：312.5uS、625uS、1.25mS、1.28S。</p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229120236696.png?raw=true" alt="这里写图片描述"></p>
<ol>
<li><strong>CLKN：</strong>本地时钟：</li>
<li><strong>CLKE:</strong>预计时钟，扫描寻呼过程中用到；</li>
<li><p><strong>CLK：</strong>设备实际运行的时钟频率。</p>
<p>CLKE、CLK由CLKN加上一个偏移量得到的。</p>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229124607640.png?raw=true" alt="这里写图片描述"></p>
</li>
</ol>
<h4 id="4、蓝牙物理链路："><a href="#4、蓝牙物理链路：" class="headerlink" title="4、蓝牙物理链路："></a>4、蓝牙物理链路：</h4><p>通信设备间物理层的数据连接通道就是物理链路。</p>
<p>ACL（Asynchronous Connectionless）异步无连接链路；对时间要求不敏感的数据通信，如文件数据、控制信令等。</p>
<p>SCO（Synochronous Connection Oriented）同步面向连接链路；对时间比较敏感的通信，如：语音；最多只支持3条SCO链路，不支持重传。</p>
<p>ACL用于数据传输；</p>
<h4 id="5、蓝牙基带分组："><a href="#5、蓝牙基带分组：" class="headerlink" title="5、蓝牙基带分组："></a>5、蓝牙基带分组：</h4><pre><code>基带分组至少包括：接入码、分组头、有效载荷；
</code></pre><p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229133330554.png?raw=true" alt="列表内容"></p>
<p><strong>（1）、接入码</strong>用于同步、直流、载频泄漏偏置补偿标识；<br><strong>（2）、分组头</strong>包含链路信息，确保纠正较多的错误。<br>分组类型如下：</p>
<table><tr><td>分组类别</td><td>Type(b3b2b1b0)</td><td>时隙</td><td>SCO</td><td>ACL</td></tr><tr><td rowspan="4">链路控制分组</td><td>0000 </td><td rowspan="4">1</td><td>NULL</td><td>NULL</td></tr><tr><td>0001 </td><td>POLL</td><td>POLL</td></tr><tr><td>0010 </td><td>FHS</td><td>FHS</td></tr><tr><td>0011 </td><td>DM1</td><td>DM1</td></tr><td rowspan="6">单时隙分组</td><td>0100</td><td rowspan="6">1</td><td>未定义</td><td rowspan="5">NULL</td><tr><td>0101</td><td>HV1</td></tr><tr><td>0110</td><td>HV2</td></tr><tr><td>0111</td><td>HV3</td></tr><tr><td>1000</td><td>DV</td></tr><tr><td>1001</td><td>NULL</td><td>AUX1</td></tr><td rowspan="4">3时隙分组</td><td>1010</td><td rowspan="4">3</td><td rowspan="4">未定义</td><td>DM3</td><tr><td>1011</td><td>DH3</td></tr><tr><td>1100</td><td rowspan="2">未定义</td></tr><tr><td>1101</td></tr><td rowspan="2">5时隙分组</td><td>1010</td><td rowspan="2">5</td><td rowspan="2">未定义</td><td rowspan="2">DM5</td><tr><td>1111</td></tr></table>

<p>ACL分组形式为：D(M|H)（1|3|5）,D代表数据分组，M代表用2/3比例的FEC的中等速率分组；H代表不使用纠错码的高速率分组；1、3、5分别代表分组所占用的时隙数目；<br>    DM1、DM3、DM5、DH1、DH3、DH5</p>
<p>SCO分组形式为：HV(1|2|3)。HV代表高质量语言分组，1、2、3有效载荷所采用的纠错码方法。1为1/3比例FEC，设备2个时隙发送一个单时隙分组；2为2/3比例FEC，设备4个时隙发送一个单时隙分组；3为不使用纠错码，设备6个时隙发送一个单时隙分组</p>
<p>HV1、HV2、HV3</p>
<p><strong>ALC 分组：</strong></p>
<table><tr><tdrowspan=2>类型<tdrowspan=2>有效载荷头/字节<tdrowspan=2>用户有效载荷/字节<tdrowspan=2>FEC<tdrowspan=2>CRC<tdrowspan=2>对称最大速率/kbps<tdcolspan=2>非对称速率/kbps</tdcolspan=2></tdrowspan=2></tdrowspan=2></tdrowspan=2></tdrowspan=2></tdrowspan=2></tdrowspan=2></tr><tr><td>前向</td><td>后向</td></tr><tr><td>DM1</td><td>1</td><td>0～17</td><td>2/3</td><td>有</td><td>108.8</td><td>108.8</td><td>108.8</td></tr><tr><td>DH1</td><td>1</td><td>0～27</td><td>无</td><td>有</td><td>172.8</td><td>172.8</td><td>172.8</td></tr><tr><td>DM3</td><td>2</td><td>0～121</td><td>2/3</td><td>有</td><td>258.1</td><td>387.2</td><td>54.4</td></tr><tr><td>DH3</td><td>2</td><td>0～183</td><td>无</td><td>有</td><td>390.4</td><td>585.6</td><td>86.4</td></tr><tr><td>DM5</td><td>2</td><td>0～224</td><td>2/3</td><td>有</td><td>286.7</td><td>477.8</td><td>36.3</td></tr><tr><td>MH5</td><td>2</td><td>0～339</td><td>无</td><td>有</td><td>433.9</td><td>723.2</td><td>57.6</td></tr><tr><td>AUX1</td><td>1</td><td>0～29</td><td>无</td><td>无</td><td>185.6</td><td>185.6</td><td>185.6</td></tr></table><br><strong>SCO分组：</strong><br><table><tr><td>类型</td><td>有效载荷头/字节</td><td>用户有效载荷/字节</td><td>FEC</td><td>CRC</td><td>有效载荷长度</td><td>同步速率/kbps</td><td>占用Tsco数目/语言长度</td></tr><tr><td>HV1</td><tdrowspan=3>无<td>10</td><td>1/3</td><tdrowspan=3><tdrowspan=4>240位<tdrowspan=3>64<td>2/1.25ms</td></tdrowspan=3></tdrowspan=4></tdrowspan=3></tdrowspan=3></tr><tr><td>HV2</td><td>20</td><td>2/3</td><td>4/2.5ms</td></tr><tr><td>HV3</td><td>30</td><td>无</td><td>6/3.75ms</td></tr><tr><td>DV</td><td>1D</td><td>10+(0-9)D</td><td>2/3D</td><td>有D</td><td>64+57.6D</td><td></td></tr></table>

<pre><code>注释：D 只对数据段有用，DV分组包含数据段，也包含语言段。
</code></pre><p><strong>（3）、有效载荷</strong>  分语言有效载荷、数据有效载荷。</p>
<h4 id="6、蓝牙的逻辑信道"><a href="#6、蓝牙的逻辑信道" class="headerlink" title="6、蓝牙的逻辑信道"></a>6、蓝牙的逻辑信道</h4><ul>
<li>链路控制信道：LinkControl  LC</li>
<li>链路管理信道：Link Manage LM</li>
<li>用户异步数据信道：User AsynchronizationUA</li>
<li>用户同步数据信道：UserSynchronization US</li>
<li>用户等时数据信道：UserIsochronous UI  UI</li>
</ul>
<h4 id="7、蓝牙的收发规则"><a href="#7、蓝牙的收发规则" class="headerlink" title="7、蓝牙的收发规则"></a>7、蓝牙的收发规则</h4><p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229143427545.png?raw=true" alt="这里写图片描述"><br>上图为RX缓存。<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229143503808.png?raw=true" alt="这里写图片描述"><br>上图为TX缓存。<br>新分组到达时，ACL链路的RX缓存器要流量控制，SCO数据不需要流量控制；</p>
<h4 id="8、蓝牙基带信道和网络控制"><a href="#8、蓝牙基带信道和网络控制" class="headerlink" title="8、蓝牙基带信道和网络控制"></a>8、蓝牙基带信道和网络控制</h4><p><strong>（1）、链路控制器状态：</strong><br>    待机、连接<br>    寻呼page、寻呼扫描pagescan、查询inquiry、查询扫描inquiry scan、主设备相应Master Response、从设备相应Slave Response、查询相应inquiry response<br><strong>（2） 、连接状态</strong><br>    激活模式active、呼吸模式sniff、保持模式hold、休眠模式park。<br><strong>（3）、待机状态</strong><br>         待机状态是蓝牙设备缺省低功耗状态，此状态下本地时钟以低精度运行。蓝牙从待机转入寻呼扫描状态，对其他<font color="red">寻呼进行响应</font>成为<font color="blue">从设备</font>；也可以从待机状态进入<font color="red">查询扫描状态</font>，完成一个完整的寻呼，成为<font color="blue">主设备</font>。</p>
<h4 id="9、接入过程"><a href="#9、接入过程" class="headerlink" title="9、接入过程"></a>9、接入过程</h4><p>注释：<br>    IAC Inquiry AccessCode 查询接入码；<br>    GIAC:通用查询接入码 DIAC：专用查询接入码；<br>    DAC：DeviceAccess Code 设备接入码；<br>LAP：<br>         建立连接，必须使用查询、寻呼；查询过程使用IAC，发现覆盖区域内的设备、设备的地址及其时钟；连接过程使用DAC，建立连接的设备处理寻呼过程，成为主设备。</p>
<p> <strong>（1）、查询过程</strong><br>    蓝牙设备通过查询来发现通信范围内的其他蓝牙设备。查询信息分为GIAC、DIAC两种。查询发起设备收集所有相应设备的地址、时钟信息。<br>    一设备进入查询状态去发现其他设备，查询状态下连续不断的在不同频点发送查询消息。查询的跳频序列有GIAC的LAP导出。<br>    一设备想被其他设备发现，就要周期性进入 查询扫描状态，以便相应查询消息。如：我们选择设备多长时间可见，其实就是  进入查询扫描状态。<br><strong>A、查询扫描</strong><br>    查询扫描状态下，接收设备扫描接入码的时间长度，足以完成对16个频率的扫描。扫描区间长度Twindow inquiry scan。扫描在同一个频率上进行，查询过程用32跳专用查询跳频序列，此序列有通用查询的地址决定，相位有本地时钟决定，每隔1.28S变化一次。<br><strong>B、查询</strong><br>    与寻呼类似，TX用查询跳频序列、RX用查询相应跳频序列。<br><strong>C、查询相应</strong><br>    从设备响应查询操作。每个设备都有自己的时钟，使用查询序列相位相同的几率比较小。为了避免多个设备在同一查询跳频信道同时激活，从设备查询响应规定：从设备收到查询消息，产生0-1023只觉得额一个随机数，锁定当时相位输入值进行跳频选择，从设备此后的RAND时隙中返回到连接或者待机状态。</p>
<p> <strong>（2）、寻呼扫描</strong><br>    DAC：DeviceAccess Code 设备接入码<br>    寻呼扫描状态下的设备扫描窗口Twindowpage scan内监听自己的DAC。监听只在一个跳频点进行。Twindow page scan足够覆盖16个寻呼扫描频点。<br>    寻呼扫描状态，扫描在同一个频率上进行，持续1.28S，在选择另一个不同频率。</p>
<p><table><tr><td>SR模式</td><td>Tpagescan</td><td>寻呼次数Npage</td></tr><tr><td>R0</td><td>连续</td><td>&gt;=1</td></tr><tr><td>R1</td><td>&lt;=1.28S</td><td>&gt;=128</td></tr><tr><td>R2</td><td>&lt;=2.56S</td><td>&gt;=256</td></tr><tr><td>预留</td><td>–</td><td>–</td></tr></table><br><strong>（3）、寻呼</strong><br>    主设备使用寻呼发起一个主—从设备连接，通过在不同的跳频点上重复发送从设备DAC来扑捉从设备，从设备在寻呼扫描状态被唤醒，接收寻呼。<br><strong>（4）、寻呼相应过程</strong></p>
<h3 id="三、链路管理器"><a href="#三、链路管理器" class="headerlink" title="三、链路管理器"></a>三、链路管理器</h3><p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol2/20171229144429343.png?raw=true" alt="这里写图片描述"><br>如上图红色部分，负责完成设备：功率管理、链路质量管理、链路控制管理、数据分组管理、链路安全管理。</p>
<h4 id="1、链路管理协议数据单元"><a href="#1、链路管理协议数据单元" class="headerlink" title="1、链路管理协议数据单元"></a>1、链路管理协议数据单元</h4><p>蓝牙链路管理器接收到高层的控制信息后，不是向自身的基带部分分发控制信息，就是与另一台设备的链路管理器进行协商管理。这些控制信息封装在链路管理协议数据单元LMP_PDU中，由ACL分组的有效载荷携带。</p>
<h4 id="2、链路管理器协议规范"><a href="#2、链路管理器协议规范" class="headerlink" title="2、链路管理器协议规范"></a>2、链路管理器协议规范</h4><p><strong>（1）、设备功率管理</strong><br>         RSSI保持模式、呼吸模式、休眠模式。<br><strong>（2）、链路质量管理 QoSQuality of Service</strong><br>    A、ACL链路。<br>    B、SCO链路。<br><strong>（3）、链路控制管理</strong><br>    设备寻呼模式、设备角色转换、时钟计时设置、信息交换:版本信息、支持特性、设备名称；建立连接、链路释放。<br><strong>（4）、数据分组管理</strong></p>
<p>传送门：<br><a href="http://xiaolongonly.cn/2017/11/01/BluetoothForAndroid2/" target="_blank" rel="external">（一）蓝牙的概述</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid3/" target="_blank" rel="external">（二）蓝牙协议规范（射频、基带链路控制、链路管理）</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid4/" target="_blank" rel="external">（三）蓝牙协议规范（HCI、L2CAP、SDP、RFOCMM）</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid5/" target="_blank" rel="external">（四）蓝牙协议规范（irOBEX、BNEP、AVDTP、AVCTP）</a></p>
<p><a href="http://blog.csdn.net/xubin341719" target="_blank" rel="external">引用自xubin的博客</a></p>
<p><strong><em>By Xiaolong,每一天都值得被认真对待！</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2017/11/01/BluetoothForAndroid1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/01/BluetoothForAndroid1/" itemprop="url">
                  Android 端蓝牙模块的开发
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-01T17:31:58+08:00">
                2017-11-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android蓝牙/" itemprop="url" rel="index">
                    <span itemprop="name">Android蓝牙</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>###背景<br>因为可穿戴设备等硬件设备的兴起，蓝牙模块的开发已经成为大多数移动开发者必备的技能。<br>这段时间由于业务需求，花了一阵子的时间在研究蓝牙模块的传输。也整理了一些相关的经验拿出来分享给大家。</p>
<h3 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h3><p>在此过程中需要大家先了解一下，在蓝牙开发过程中经常碰到的名词。BLE,SPP,OPP等。</p>
<ol>
<li>BLE（Bluetooth Low Energy）——蓝牙低功耗技术，这是蓝牙4.0推出的一个低功耗蓝牙部分。低功耗蓝牙适用于实时性要求比较高，但是数据速率比较低的产品，如遥控类的，如鼠标，键盘，遥控鼠标(Air Mouse)，传感设备的数据发送，如心跳带，血压计，温度传感器等。</li>
<li>SPP（Serial Port Profile）—— SPP为蓝牙串口传输协议，能在蓝牙设备之间创建串口进行数据传输的协议。蓝牙串口的目的是针对如何在两个不同设备（通信的两端）上的应用之间保证一条完整的通信路径。<br> 当然SSP还有另外一个名词，简单配对模式(Secure Simple Pairing).</li>
<li>OPP（Object push profile） 面向对象传输协议，用于文件文件传输。</li>
<li>HFP (Hands-free Profile) HFP(Hands-free Profile)，让蓝牙设备可以控制电话，如接听、挂断、拒接、语音拨号等，拒接、语音拨号要视蓝牙耳机及电话是否支持</li>
</ol>
<p>更多蓝牙协议可以到<a href="http://blog.csdn.net/guoxiaolongonly/article/details/78414870" target="_blank" rel="external">蓝牙协议介绍</a><br>大家可以根据需求选择相应的功能做开发。<br>代码还在github上，有时间继续整理~~  囧~ 这里会把ble和普通蓝牙spp,文件传输 opp开发做整理。</p>
<p><strong><em>By Xiaolong,每一天都值得被认真对待！</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2017/11/01/BluetoothForAndroid2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/01/BluetoothForAndroid2/" itemprop="url">
                  蓝牙协议学习整理（一）蓝牙的概述
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-01T15:45:51+08:00">
                2017-11-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android蓝牙/" itemprop="url" rel="index">
                    <span itemprop="name">Android蓝牙</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="第一章-蓝牙的概述"><a href="#第一章-蓝牙的概述" class="headerlink" title="第一章 蓝牙的概述"></a>第一章 蓝牙的概述</h2><h3 id="一、蓝牙版本信息"><a href="#一、蓝牙版本信息" class="headerlink" title="一、蓝牙版本信息"></a>一、蓝牙版本信息</h3><p>蓝牙共有六个版本1.1/1.2/2.0/2.1/3.0/4.0</p>
<h4 id="1、1-1版本"><a href="#1、1-1版本" class="headerlink" title="1、1.1版本"></a>1、1.1版本</h4><p>传输率约在748~810kb/s，因是早期设计，容易受到同频率之产品所干扰下影响通讯质量。</p>
<h4 id="2、1-2版本"><a href="#2、1-2版本" class="headerlink" title="2、1.2版本"></a>2、1.2版本</h4><p>同样是只有748~810kb/s 的传输率，但在加上了(改善 Software)抗干扰跳频功能。</p>
<h4 id="3、2-0-EDR版本"><a href="#3、2-0-EDR版本" class="headerlink" title="3、2.0+EDR版本"></a>3、2.0+EDR版本</h4><p>是1.2的改良提升版，传输率约在1.8M/s~2.1M/s，开始支持双工模式——即一面作语音通讯，同时亦可以传输档案/高质素图片，2.0 版本当然也支持 Stereo 运作。</p>
<p>应用最为广泛的是Bluetooth2.0+EDR标准，该标准在2004年已经推出，支持Bluetooth 2.0+EDR标准的产品也于2006年大量出现。虽然Bluetooth 2.0+EDR标准在技术上作了大量的改进，但从1.X标准延续下来的配置流程复杂和设备功耗较大的问题依然存在。</p>
<h4 id="4、2-1版本"><a href="#4、2-1版本" class="headerlink" title="4、2.1版本"></a>4、2.1版本</h4><p>更佳的省电效果：蓝牙2.1版加入了SniffSubrating的功能，透过设定在2个装置之间互相确认讯号的发送间隔来达到节省功耗的目的。</p>
<h4 id="5、3-0-HS版本"><a href="#5、3-0-HS版本" class="headerlink" title="5、3.0+HS版本"></a>5、3.0+HS版本</h4><p>2009年4月21日，蓝牙技术联盟(Bluetooth SIG)正式颁布了新一代标准规范”Bluetooth Core Specification Version 3.0 High Speed”(蓝牙核心规范3.0版 )，蓝牙3.0的核心是”GenericAlternate MAC/PHY”(AMP)，这是一种全新的交替射频技术，允许蓝牙协议栈针对任一任务动态地选择正确射频。最初被期望用于新规范的技术包括802.11以及UMB，但是新规范中取消了UMB的应用。</p>
<h4 id="6、4-0-版本"><a href="#6、4-0-版本" class="headerlink" title="6、4.0 版本"></a>6、4.0 版本</h4><p>蓝牙4.0包括三个子规范，即传统蓝牙技术、高速蓝牙和新的蓝牙低功耗技术。蓝牙 4.0的改进之处主要体现在三个方面，电池续航时间、节能和设备种类上。拥有低成本，跨厂商互操作性，3毫秒低延迟、100米以上超长距离、AES-128加密等诸多特色此外，蓝牙4.0的有效传输距离也有所提升。3.0版本的蓝牙的有效传输距离为10米(约 32英尺)，而蓝牙4.0的有效传输距离最高可达到100米(约328英尺)。</p>
<h4 id="7、典型蓝牙与BLE蓝牙对比"><a href="#7、典型蓝牙与BLE蓝牙对比" class="headerlink" title="7、典型蓝牙与BLE蓝牙对比"></a>7、典型蓝牙与BLE蓝牙对比</h4><p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol1/20171229112207537.png?raw=true" alt="蓝牙与BLE对比"></p>
<h3 id="二、蓝牙的技术特点"><a href="#二、蓝牙的技术特点" class="headerlink" title="二、蓝牙的技术特点"></a>二、蓝牙的技术特点</h3><p>简单地说，蓝牙是一种短程宽带无线电技术，是实现语音和数据无线传输的全球开放性标准。它使用跳频扩谱（FHSS）、时分多址（TDMA）、码分多址（CDMA）等先进技术，在小范围内建立多种通信与信息系统之间的信息传输。</p>
<h4 id="1、Bluetooth的主要技术特点："><a href="#1、Bluetooth的主要技术特点：" class="headerlink" title="1、Bluetooth的主要技术特点："></a>1、Bluetooth的主要技术特点：</h4><p><strong>（1）、工作频段</strong> ：2.4GHz的工科医（ISM）频段，无需申请许可证。大多数国家使用79个频点，载频为(2402+k)MHz（k=0，1, 2…78），载频间隔1MHz。采用TDD时分双工方式。<br><strong>（2）、传输速率</strong>：1Mb/s（V2.0以上版本）<br><strong>（3）、调试方式</strong>：BT=0.5的GFSK调制，调制指数为0.28-0.35。<br><strong>（4）、采用跳频技术</strong>：跳频速率为1600跳/秒，在建链时（包括寻呼和查询）提高为3200跳/秒。蓝牙通过快跳频和短分组技术减少同频干扰，保证传输的可靠性。<br><strong>（5）、语音调制方式</strong>：连续可变斜率增量调制（CVSD，ContinuousVariable Slope Delta Modulation），抗衰落性强，即使误码率达到4%，话音质量也可接受。<br><strong>（6）、支持电路交换和分组交换业务</strong>：蓝牙支持实时的同步定向联接（SCO链路）和非实时的异步不定向联接（ACL链路），前者主要传送语音等实时性强的信息，后者以数据包为主。语音和数据可以单独或同时传输。蓝牙支持一个异步数据通道，或三个并发的同步话音通道，或同时传送异步数据和同步话音的通道。每个话音通道支持64kbps的同步话音；异步通道支持723.2/57.6kbps的非对称双工通信或433.9kbps的对称全双工通信。<br><strong>（7）、支持点对点及点对多点通信</strong>：蓝牙设备按特定方式可组成两种网络：微微网(Piconet)和分布式网络(Scatternet)，其中微微网的建立由两台设备的连接开始，最多可由八台设备组成。在一个微微网中，只有一台为主设备（Master），其它均为从设备（Slave），不同的主从设备对可以采用不同的链接方式，在一次通信中，链接方式也可以任意改变。几个相互独立的微微网以特定方式链接在一起便构成了分布式网络。所有的蓝牙设备都是对等的，所以在蓝牙中没有基站的概念。<br><strong>（8）、工作距离</strong>：蓝牙设备分为三个功率等级，分别是：100mW（20dBm）、2.5mW（4dBm）和1mW（0dBm），相应的有效工作范围为：100米、10米和1米。</p>
<h3 id="三、Bluetooth的系统构成"><a href="#三、Bluetooth的系统构成" class="headerlink" title="三、Bluetooth的系统构成"></a>三、Bluetooth的系统构成</h3><p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol1/20171229113217333.png?raw=true" alt="构成"></p>
<h4 id="1、无线射频单元-Radio-："><a href="#1、无线射频单元-Radio-：" class="headerlink" title="1、无线射频单元(Radio)："></a>1、无线射频单元(Radio)：</h4><p>负责数据和语音的发送和接收，特点是短距离、低功耗。蓝牙天线一般体积小、重量轻，属于微带天线。</p>
<h4 id="2、基带或链路控制单元-LinkController-："><a href="#2、基带或链路控制单元-LinkController-：" class="headerlink" title="2、基带或链路控制单元(LinkController)："></a>2、基带或链路控制单元(LinkController)：</h4><p>进行射频信号与数字或语音信号的相互转化，实现基带协议和其它的底层连接规程。</p>
<h4 id="3、链路管理单元-LinkManager-："><a href="#3、链路管理单元-LinkManager-：" class="headerlink" title="3、链路管理单元(LinkManager)："></a>3、链路管理单元(LinkManager)：</h4><p>负责管理蓝牙设备之间的通信，实现链路的建立、验证、链路配置等操作。</p>
<h4 id="4、蓝牙软件协议实现："><a href="#4、蓝牙软件协议实现：" class="headerlink" title="4、蓝牙软件协议实现："></a>4、蓝牙软件协议实现：</h4><p>如上图紫色部分，这个后面我们做详细说明。<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol1/20171229113418020.png?raw=true" alt="这里写图片描述"></p>
<h3 id="四、蓝牙协议规范"><a href="#四、蓝牙协议规范" class="headerlink" title="四、蓝牙协议规范"></a>四、蓝牙协议规范</h3><p>传输协议、中介协议、应用协议；</p>
<h4 id="1、传输协议"><a href="#1、传输协议" class="headerlink" title="1、传输协议"></a>1、传输协议</h4><p>负责蓝牙设备间，互相确认对方的位置，以及建立和管理蓝牙设备间的物理链路；</p>
<ul>
<li><p>底层传输协议：蓝牙射频（Radio）部分、基带链路管理控制器（Baseband&amp;Link Controller）、链路管理协议（Link ManagerProtocol LMP）。负责语言、数据无线传输的物理实现以及蓝牙设备间的联网组网。</p>
</li>
<li><p>高层传输协议：逻辑链路控制与适配器（LogicalLink Control and Adaptation Protocol）L2CAP 、主机控制接口（HostControl Interface，HCI）。为高层应用屏蔽了跳频序列选择等底层传输操作，为高层程序提供有效、有利于实现数据分组格式。</p>
</li>
</ul>
<h4 id="2、中介协议"><a href="#2、中介协议" class="headerlink" title="2、中介协议"></a>2、中介协议</h4><p>为高层应用协议或者程序，在蓝牙逻辑链路上工作提供必要的支持，为应用提供不同标准接口。</p>
<ul>
<li>串口仿真协议：RFCOMM、服务发现协议：SDP、互操作协议IrDA、网络访问协议：PPP、IP、TCP、UDP、电话控制协议：TCS、AT指令集。</li>
</ul>
<p><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol1/20171229114202004.png?raw=true" alt="这里写图片描述"></p>
<h4 id="3、应用协议"><a href="#3、应用协议" class="headerlink" title="3、应用协议"></a>3、应用协议</h4><p>蓝牙协议栈之上的应用软件和所涉及到的协议，如：拨号上网、语言功能的应用程序。</p>
<p>蓝牙的应用框架如下：</p>
<ol>
<li>通用应用类框架：查询、建立连接服务等；</li>
<li>蓝牙电话应用类框架：电话控制、语言；</li>
<li>蓝牙连网应用类框架：网络应用相关；</li>
<li>对象交互服务类框架：IrDA、OBEX；</li>
<li>蓝牙音视频控制类框架。</li>
</ol>
<h3 id="五、硬件接口"><a href="#五、硬件接口" class="headerlink" title="五、硬件接口"></a>五、硬件接口</h3><p>一般蓝牙芯片通过UART、USB、SDIO、I2S、PcCard和主控芯片通信。如下图所示，通过UART和主控芯片通信。<br><img src="https://github.com/guoxiaolongonly/BlogCache/blob/master/img/Bluetooth%20Protocol1/20171229114547261.png?raw=true" alt="这里写图片描述"></p>
<p>传送门：<br><a href="http://xiaolongonly.cn/2017/11/01/BluetoothForAndroid2/" target="_blank" rel="external">（一）蓝牙的概述</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid3/" target="_blank" rel="external">（二）蓝牙协议规范（射频、基带链路控制、链路管理）</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid4/" target="_blank" rel="external">（三）蓝牙协议规范（HCI、L2CAP、SDP、RFOCMM）</a><br><a href="http://xiaolongonly.cn/2017/12/29/BluetoothForAndroid5/" target="_blank" rel="external">（四）蓝牙协议规范（irOBEX、BNEP、AVDTP、AVCTP）</a><br><a href="http://blog.csdn.net/xubin341719" target="_blank" rel="external">引用自xubin的博客</a></p>
<p><strong><em>By Xiaolong,每一天都值得被认真对待！</em></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/lucky.jpg"
               alt="小龙" />
          <p class="site-author-name" itemprop="name">小龙</p>
           
              <p class="site-description motion-element" itemprop="description">程序猿</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xiaolongonly" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/guoxiaolongonly" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-android"></i>
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小龙</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
