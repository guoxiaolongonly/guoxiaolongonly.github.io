<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="学习,EventBus源码解析," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="为什么要使用EventBus在Android开发过程中经常有这样的场景–&amp;gt;栈顶Activity需要关闭非栈顶的Activity，或调用其中的某些方法。
案例：我有三个Activity，主界面Activity,个人中心Activity，登录界面Activity，主界面打开了个人中心页面，个人中心页面有个退出登录的功能，点击后退出登录关闭主界面Activity和当前Activity,打开登录页面">
<meta property="og:type" content="article">
<meta property="og:title" content="EventBus">
<meta property="og:url" content="http://rngift.com/2017/03/31/EventBusSource/index.html">
<meta property="og:site_name" content="Xiaolong的个人博客">
<meta property="og:description" content="为什么要使用EventBus在Android开发过程中经常有这样的场景–&amp;gt;栈顶Activity需要关闭非栈顶的Activity，或调用其中的某些方法。
案例：我有三个Activity，主界面Activity,个人中心Activity，登录界面Activity，主界面打开了个人中心页面，个人中心页面有个退出登录的功能，点击后退出登录关闭主界面Activity和当前Activity,打开登录页面">
<meta property="og:image" content="http://img.blog.csdn.net/20170325221620023?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VveGlhb2xvbmdvbmx5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
<meta property="og:image" content="http://img.blog.csdn.net/20170330145236125?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VveGlhb2xvbmdvbmx5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">
<meta property="og:updated_time" content="2017-05-09T13:26:12.761Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="EventBus">
<meta name="twitter:description" content="为什么要使用EventBus在Android开发过程中经常有这样的场景–&amp;gt;栈顶Activity需要关闭非栈顶的Activity，或调用其中的某些方法。
案例：我有三个Activity，主界面Activity,个人中心Activity，登录界面Activity，主界面打开了个人中心页面，个人中心页面有个退出登录的功能，点击后退出登录关闭主界面Activity和当前Activity,打开登录页面">
<meta name="twitter:image" content="http://img.blog.csdn.net/20170325221620023?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VveGlhb2xvbmdvbmx5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://rngift.com/2017/03/31/EventBusSource/"/>





  <title>EventBus | Xiaolong的个人博客</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xiaolong的个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">爱生活，爱学习</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/pastLove" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            爱过的人
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://rngift.com/2017/03/31/EventBusSource/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小龙">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/lucky.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaolong的个人博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                EventBus
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-31T14:08:11+08:00">
                2017-03-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解析/" itemprop="url" rel="index">
                    <span itemprop="name">源码解析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="为什么要使用EventBus"><a href="#为什么要使用EventBus" class="headerlink" title="为什么要使用EventBus"></a>为什么要使用EventBus</h2><p>在Android开发过程中经常有这样的场景–&gt;栈顶Activity需要关闭非栈顶的Activity，或调用其中的某些方法。</p>
<p>案例：我有三个Activity，主界面Activity,个人中心Activity，登录界面Activity，主界面打开了个人中心页面，个人中心页面有个退出登录的功能，点击后退出登录关闭主界面Activity和当前Activity,打开登录页面.</p>
<p>这只是个简单的案例，当然关闭当前Activity和打开登录页面的Activity都是没什么难度的东西。</p>
<p>我们来讨论主界面关闭的一些实现方案。</p>
<ol>
<li><p>得到主界面Activity的对象。这边可能需要某个静态方法来持有这个对象，以前见过一种写法是写一个ActivityManager来持有这些Activity对象，然后手动管理这些Activity。</p>
</li>
<li><p>发送一个广播通知主界面Activity.</p>
</li>
<li><p>在当前Activity销毁时传一个resultCode，主界面看到这个resultCode来判断是否是否要做关闭操作。</p>
</li>
</ol>
<p>暂时能想到的就这三种实现方案，分析一下三种实现：</p>
<blockquote>
<p>第三种实现方案并不适用于比如我现在是主界面–&gt;个人主页–&gt;个人中心，做第三种方案的话代码写到哭晕在厕所，并且第三种方案代码写起来会很复杂，页面可能还没关掉就把自己绕晕了（个人想法，不推荐！）</p>
<p>第二种实现方案：发送一个广播做通知，其实是一个蛮不错的选择，发送广播然后实现广播类做回调通知。但是如果现在需求是对一个Fragment做通知。这个时候广播就派不上用场了。毕竟广播只能再Activity中注册发送广播。</p>
<p>第一种实现方案：这种方案在以前还是蛮常见的，以前学Android的时候会看到一些大牛们，自己写一个ActivityManager用来存放Activity对象做生命周期管理。但是这样做其实是会有问题的。因为持有的是Activity的对象，这就导致了Activity只能手动销毁。每次写关闭页面的时候都要调用这个方法来销毁Activity，不然分分钟就OOM了。还有另外一个缺点就是需要遍历整个栈来确定存活的Activity对象。找到你要找的Activity，然后调用其中的方法。如果是要销毁则还要将它移除栈中。（心很累）</p>
</blockquote>
<p>想想这些方法真的都好难用呀。<br>这个时候就需要来个上帝来管理这些东西了。EventBus一脸害羞的跳出来了。一种全局的观察者模式，你可以把你的愿望（Event）请求post给这位上帝，它提供多线程的处理方案，来让你的(愿望)在你指定的地方实现。</p>
<h2 id="EventBus使用"><a href="#EventBus使用" class="headerlink" title="EventBus使用"></a>EventBus使用</h2><p> 在<a href="https://github.com/greenrobot/EventBus" target="_blank" rel="external">Github</a>上可以看到gradle所需配置<br> <figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">compile</span> <span class="string">'org.greenrobot:eventbus:3.0.0'</span></div></pre></td></tr></table></figure></p>
<p> 在gradle文件做上如上配置就可以了</p>
<p>分三个步骤</p>
<ol>
<li>定义一个作为通知的实体类Event;</li>
<li>在需要订阅的地方做注册和取消注册，写一个订阅方法(方法需要写注解 @Subscribe(threadMode = ThreadMode.XXX))</li>
<li>在任意地方调用EventBus.getDefault().post(Event());</li>
</ol>
<p>简单代码如下：<br>在MainActivity注册和解除注册，并写出订阅方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.example.cncn.myapplication;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.EventBus;</div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.Subscribe;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        <span class="comment">//注册一个EventBus</span></div><div class="line">        EventBus.getDefault().register(<span class="keyword">this</span>);</div><div class="line">        findViewById(R.id.tvClickView).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                startActivity(<span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, UserInfoActivity.class));</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Subscribe</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMainEvent</span><span class="params">(Event event)</span> </span>&#123;</div><div class="line">        <span class="comment">//打印对象的地址信息</span></div><div class="line">        Log.d(<span class="string">"MainActivity"</span>, <span class="string">"EventInfo"</span> + event.toString() + <span class="string">"_"</span> + event.eventInfo);</div><div class="line">        finish();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        Log.d(<span class="string">"MainActivity"</span>,<span class="string">"我被关掉了"</span>);</div><div class="line">        <span class="comment">//如果已经注册，千万别忘了取消注册</span></div><div class="line">        <span class="keyword">if</span> (EventBus.getDefault().isRegistered(<span class="keyword">this</span>))</div><div class="line">            EventBus.getDefault().unregister(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在UserInfoActivity发送通知</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.example.cncn.myapplication;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.os.PersistableBundle;</div><div class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</div><div class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.widget.TextView;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.EventBus;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by xiaolong on 2017/3/24.</div><div class="line"> * Email:719243738@qq.com</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> TextView tvClickView;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        tvClickView = (TextView) findViewById(R.id.tvClickView);</div><div class="line">        tvClickView.setText(<span class="string">"点我退出登录！"</span>);</div><div class="line">        tvClickView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                startActivity(<span class="keyword">new</span> Intent(UserInfoActivity.<span class="keyword">this</span>, LoginActivity.class));</div><div class="line">                Event event = <span class="keyword">new</span> Event(<span class="number">110</span>, <span class="string">"关闭页面吧！！"</span>);</div><div class="line">                Log.d(<span class="string">"UserInfoActivity"</span>, event.toString());</div><div class="line">                EventBus.getDefault().post(event);</div><div class="line">                finish();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LoginActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.example.cncn.myapplication;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</div><div class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.widget.TextView;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by xiaolong on 2017/3/24.</div><div class="line"> * Email:719243738@qq.com</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> TextView tvClickView;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        tvClickView = (TextView) findViewById(R.id.tvClickView);</div><div class="line">        tvClickView.setText(<span class="string">"点我登录！"</span>);</div><div class="line">        tvClickView.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                startActivity(<span class="keyword">new</span> Intent(LoginActivity.<span class="keyword">this</span>,MainActivity.class));</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.example.cncn.myapplication;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by xiaolong on 2017/3/24.</div><div class="line"> * Email:719243738@qq.com</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> eventCode;</div><div class="line">    <span class="keyword">public</span> String eventInfo;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">(<span class="keyword">int</span> eventCode, String eventInfo)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.eventCode = eventCode;</div><div class="line">        <span class="keyword">this</span>.eventInfo = eventInfo;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果</p>
<p><img src="http://img.blog.csdn.net/20170325221620023?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VveGlhb2xvbmdvbmx5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="打印接锅"></p>
<p>如此简单便捷的使用方式，确实是做消息通知的不二选择。不过在注册过EventBus的类中，千万别忘了在结束的时候取消注册，不然会报错。不过报错总比那些没报错强引用了这个对象的好~~这么好用的东西还是需要去了解一下其内部实现的。而且EventBus内部实现其实并不复杂。</p>
<h2 id="EventBus源码解析"><a href="#EventBus源码解析" class="headerlink" title="EventBus源码解析"></a>EventBus源码解析</h2><p>注册EventBus的时候需要执行，EventBus.getDefault().register(this);<br>我们先从getDefault方法入手，看下里面做了些什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Convenience singleton for apps using a process-wide EventBus instance. */</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EventBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (EventBus.class) &#123;</div><div class="line">               <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                   defaultInstance = <span class="keyword">new</span> EventBus();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> defaultInstance;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>大致代码如下，单例模式获取一个EventBus对象，保证所有的EventBus对象是同一个。</p>
<p>进入 EventBus构造看一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Creates a new EventBus instance; each instance is a separate scope in which events are delivered. To use a</div><div class="line"> * central bus, consider &#123;<span class="doctag">@link</span> #getDefault()&#125;.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">EventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(DEFAULT_BUILDER);</div><div class="line">&#125;</div><div class="line"></div><div class="line">EventBus(EventBusBuilder builder) &#123;</div><div class="line">    subscriptionsByEventType = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    typesBySubscriber = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    stickyEvents = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</div><div class="line">    mainThreadPoster = <span class="keyword">new</span> HandlerPoster(<span class="keyword">this</span>, Looper.getMainLooper(), <span class="number">10</span>);</div><div class="line">    backgroundPoster = <span class="keyword">new</span> BackgroundPoster(<span class="keyword">this</span>);</div><div class="line">    asyncPoster = <span class="keyword">new</span> AsyncPoster(<span class="keyword">this</span>);</div><div class="line">    indexCount = builder.subscriberInfoIndexes != <span class="keyword">null</span> ? builder.subscriberInfoIndexes.size() : <span class="number">0</span>;</div><div class="line">    subscriberMethodFinder = <span class="keyword">new</span> SubscriberMethodFinder(builder.subscriberInfoIndexes,</div><div class="line">            builder.strictMethodVerification, builder.ignoreGeneratedIndex);</div><div class="line">    logSubscriberExceptions = builder.logSubscriberExceptions;</div><div class="line">    logNoSubscriberMessages = builder.logNoSubscriberMessages;</div><div class="line">    sendSubscriberExceptionEvent = builder.sendSubscriberExceptionEvent;</div><div class="line">    sendNoSubscriberEvent = builder.sendNoSubscriberEvent;</div><div class="line">    throwSubscriberException = builder.throwSubscriberException;</div><div class="line">    eventInheritance = builder.eventInheritance;</div><div class="line">    executorService = builder.executorService;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>两个构造方法，一个是无参的public的方法，另外一个是内部方法，带参数的。<br>第一个方法默认调用有参数的构造方法，来生成一个EventBus对象。<br>这边DEFAULT_BUILDER声明如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> EventBusBuilder DEFAULT_BUILDER = <span class="keyword">new</span> EventBusBuilder();</div></pre></td></tr></table></figure>
<p>存放着一个默认的EventBusBuilder对象;<br>进入EventBusBuilder中看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.greenrobot.eventbus;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SubscriberInfoIndex;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Creates EventBus instances with custom parameters and also allows to install a custom default EventBus instance.</div><div class="line"> * Create a new builder using &#123;<span class="doctag">@link</span> EventBus#builder()&#125;.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventBusBuilder</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ExecutorService DEFAULT_EXECUTOR_SERVICE = Executors.newCachedThreadPool();</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> logSubscriberExceptions = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">boolean</span> logNoSubscriberMessages = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">boolean</span> sendSubscriberExceptionEvent = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">boolean</span> sendNoSubscriberEvent = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">boolean</span> throwSubscriberException;</div><div class="line">    <span class="keyword">boolean</span> eventInheritance = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">boolean</span> ignoreGeneratedIndex;</div><div class="line">    <span class="keyword">boolean</span> strictMethodVerification;</div><div class="line">    ExecutorService executorService = DEFAULT_EXECUTOR_SERVICE;</div><div class="line">    List&lt;Class&lt;?&gt;&gt; skipMethodVerificationForClasses;</div><div class="line">    List&lt;SubscriberInfoIndex&gt; subscriberInfoIndexes;</div><div class="line"></div><div class="line">    EventBusBuilder() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Default: true */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">logSubscriberExceptions</span><span class="params">(<span class="keyword">boolean</span> logSubscriberExceptions)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.logSubscriberExceptions = logSubscriberExceptions;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Default: true */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">logNoSubscriberMessages</span><span class="params">(<span class="keyword">boolean</span> logNoSubscriberMessages)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.logNoSubscriberMessages = logNoSubscriberMessages;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Default: true */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">sendSubscriberExceptionEvent</span><span class="params">(<span class="keyword">boolean</span> sendSubscriberExceptionEvent)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sendSubscriberExceptionEvent = sendSubscriberExceptionEvent;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Default: true */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">sendNoSubscriberEvent</span><span class="params">(<span class="keyword">boolean</span> sendNoSubscriberEvent)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sendNoSubscriberEvent = sendNoSubscriberEvent;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Fails if an subscriber throws an exception (default: false).</div><div class="line">     * &lt;p/&gt;</div><div class="line">     * Tip: Use this with BuildConfig.DEBUG to let the app crash in DEBUG mode (only). This way, you won't miss</div><div class="line">     * exceptions during development.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">throwSubscriberException</span><span class="params">(<span class="keyword">boolean</span> throwSubscriberException)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.throwSubscriberException = throwSubscriberException;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * By default, EventBus considers the event class hierarchy (subscribers to super classes will be notified).</div><div class="line">     * Switching this feature off will improve posting of events. For simple event classes extending Object directly,</div><div class="line">     * we measured a speed up of 20% for event posting. For more complex event hierarchies, the speed up should be</div><div class="line">     * &gt;20%.</div><div class="line">     * &lt;p/&gt;</div><div class="line">     * However, keep in mind that event posting usually consumes just a small proportion of CPU time inside an app,</div><div class="line">     * unless it is posting at high rates, e.g. hundreds/thousands of events per second.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">eventInheritance</span><span class="params">(<span class="keyword">boolean</span> eventInheritance)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.eventInheritance = eventInheritance;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Provide a custom thread pool to EventBus used for async and background event delivery. This is an advanced</div><div class="line">     * setting to that can break things: ensure the given ExecutorService won't get stuck to avoid undefined behavior.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">executorService</span><span class="params">(ExecutorService executorService)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.executorService = executorService;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Method name verification is done for methods starting with onEvent to avoid typos; using this method you can</div><div class="line">     * exclude subscriber classes from this check. Also disables checks for method modifiers (public, not static nor</div><div class="line">     * abstract).</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">skipMethodVerificationFor</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (skipMethodVerificationForClasses == <span class="keyword">null</span>) &#123;</div><div class="line">            skipMethodVerificationForClasses = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        &#125;</div><div class="line">        skipMethodVerificationForClasses.add(clazz);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Forces the use of reflection even if there's a generated index (default: false). */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">ignoreGeneratedIndex</span><span class="params">(<span class="keyword">boolean</span> ignoreGeneratedIndex)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.ignoreGeneratedIndex = ignoreGeneratedIndex;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Enables strict method verification (default: false). */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">strictMethodVerification</span><span class="params">(<span class="keyword">boolean</span> strictMethodVerification)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.strictMethodVerification = strictMethodVerification;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Adds an index generated by EventBus' annotation preprocessor. */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventBusBuilder <span class="title">addIndex</span><span class="params">(SubscriberInfoIndex index)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(subscriberInfoIndexes == <span class="keyword">null</span>) &#123;</div><div class="line">            subscriberInfoIndexes = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        &#125;</div><div class="line">        subscriberInfoIndexes.add(index);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Installs the default EventBus returned by &#123;<span class="doctag">@link</span> EventBus#getDefault()&#125; using this builders' values. Must be</div><div class="line">     * done only once before the first usage of the default EventBus.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> EventBusException if there's already a default EventBus instance in place</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> EventBus <span class="title">installDefaultEventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (EventBus.class) &#123;</div><div class="line">            <span class="keyword">if</span> (EventBus.defaultInstance != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Default instance already exists."</span> +</div><div class="line">                        <span class="string">" It may be only set once before it's used the first time to ensure consistent behavior."</span>);</div><div class="line">            &#125;</div><div class="line">            EventBus.defaultInstance = build();</div><div class="line">            <span class="keyword">return</span> EventBus.defaultInstance;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** Builds an EventBus based on the current configuration. */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventBus <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EventBus(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>里面是一些EventBus的基础配置。打印异常信息，发送未被订阅的消息等。<br>特别需要注意的是 ignoreGeneratedIndex 这个变量是用来确定EventBus用什么方式来获取订阅方法。<br>true代表的是不优先使用索引，用反射的方式，false代表的是优先使用索引。默认是false。<br>这边有个addIndex方法是用来添加订阅方法索引的，这是3.0版本的新特性。<br>在EventBus带参数的构造函数里面初始化了 SubscriberMethodFinder 这个类，三个参数分别为索引列表，<br>是否严格方法定义，是否无视索引。</p>
<pre><code>getDefault方法总结，该方法返回一个单例的EventBus对象，如果对象没被创建就创建一个默认的EventBus对象。
</code></pre><p>接下来从注册方法下手</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Registers the given subscriber to receive events. Subscribers must call &#123;<span class="doctag">@link</span> #unregister(Object)&#125; once they</div><div class="line"> * are no longer interested in receiving events.</div><div class="line"> * &lt;p/&gt;</div><div class="line"> * Subscribers have event handling methods that must be annotated by &#123;<span class="doctag">@link</span> Subscribe&#125;.</div><div class="line"> * The &#123;<span class="doctag">@link</span> Subscribe&#125; annotation also allows configuration like &#123;<span class="doctag">@link</span></div><div class="line"> * ThreadMode&#125; and priority.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</div><div class="line">    Class&lt;?&gt; subscriberClass = subscriber.getClass();</div><div class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</div><div class="line">            subscribe(subscriber, subscriberMethod);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先是通过一个findSubscriberMethods方法找到了一个订阅者中的所有订阅方法，返回一个 List<subscribermethod>，然后之后遍历所有的订阅方法，做订阅操作。进入到findSubscriberMethods看看如何实现的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function">List&lt;SubscriberMethod&gt; <span class="title">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">       List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass);</div><div class="line">       <span class="keyword">if</span> (subscriberMethods != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> subscriberMethods;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (ignoreGeneratedIndex) &#123;</div><div class="line">           subscriberMethods = findUsingReflection(subscriberClass);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           subscriberMethods = findUsingInfo(subscriberClass);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (subscriberMethods.isEmpty()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriberClass</div><div class="line">                   + <span class="string">" and its super classes have no public methods with the @Subscribe annotation"</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           METHOD_CACHE.put(subscriberClass, subscriberMethods);</div><div class="line">           <span class="keyword">return</span> subscriberMethods;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></subscribermethod></p>
<p>findSubscriberMethods这个方法声明SubscriberMethodFinder这个类中，类中声明了一个ConcurrentHashMap用来做SubscriberMethod的缓存。</p>
<p>回到findSubscriberMethods中，首先是通过类来当key，查找在当前缓存中是否存在这个类的订阅方法列表。有就直接return 缓存中的列表。</p>
<p>没有就进入下一步，这边有两种方式来获取类中的订阅方法通过ignoreGeneratedIndex来确定获取订阅方法的方式为true时会使用反射方法获取订阅者的事件处理函数，为false时会优先使用subscriber Index（订阅方法索引）生成的SubscriberInfo来获取订阅者的事件处理函数（减少反射耗时），默认false。（使用订阅方法索引需自己构建一个EventBus对象，将在后面提及，目前的使用并不能用到索引）</p>
<p>进入findUsingInfo这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">       FindState findState = prepareFindState();<span class="comment">//这个方法用来从对象池中获取一个FindState对象，如果对象池都没有可用对象的话新建一个。用来节省创建对象的花销</span></div><div class="line">       findState.initForSubscriber(subscriberClass);</div><div class="line">       <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</div><div class="line">           findState.subscriberInfo = getSubscriberInfo(findState);</div><div class="line">           <span class="keyword">if</span> (findState.subscriberInfo != <span class="keyword">null</span>) &#123;</div><div class="line">               SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods();</div><div class="line">               <span class="keyword">for</span> (SubscriberMethod subscriberMethod : array) &#123;</div><div class="line">                   <span class="keyword">if</span> (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) &#123;</div><div class="line">                       findState.subscriberMethods.add(subscriberMethod);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               findUsingReflectionInSingleClass(findState);</div><div class="line">           &#125;</div><div class="line">           findState.moveToSuperclass();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> getMethodsAndRelease(findState);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>从FindState池——FIND_STATE_POOL中获取一个FindState对象。（SubscriberMethodFinder这个类中声明了一个FIND_STATE_POOL的对象池，这个用来存放空（并非NULL）的FIND_STATE对象，减少创建对象的花销)</li>
<li>该方法会将findState.clazz域中使用了@subscribe标注、方法中只有一个参数、且方法修饰符为public的方法，创建一个SubscriberMethod对象，并添加到findState的List<subscribermethod>集合中。</subscribermethod></li>
<li>将findState.clazz域更新为clazz = clazz.getSuperclass(); 如果该超类名字以java. javax. android.开头则clazz变成null；不再往上寻找父类；</li>
<li>拷贝一份findState的List<subscribermethod>集合并返回，最后回收findState对象,回收的只是释放这个对象内部的变量的资源占用，但这个对象还是存在的，放回对象池中，下次可以再取出来用；</subscribermethod></li>
</ol>
<p>看一下如何用反射获取订阅方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingReflection</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">        FindState findState = prepareFindState();</div><div class="line">        findState.initForSubscriber(subscriberClass);</div><div class="line">        <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</div><div class="line">            findUsingReflectionInSingleClass(findState);</div><div class="line">            findState.moveToSuperclass();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> getMethodsAndRelease(findState);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findUsingReflectionInSingleClass</span><span class="params">(FindState findState)</span> </span>&#123;</div><div class="line">        Method[] methods;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span></div><div class="line">            methods = findState.clazz.getDeclaredMethods();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">            <span class="comment">// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149</span></div><div class="line">            methods = findState.clazz.getMethods();</div><div class="line">            findState.skipSuperClasses = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">            <span class="keyword">int</span> modifiers = method.getModifiers();</div><div class="line">            <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</div><div class="line">                Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</div><div class="line">                <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;</div><div class="line">                    Subscribe subscribeAnnotation = method.getAnnotation(Subscribe.class);</div><div class="line">                    <span class="keyword">if</span> (subscribeAnnotation != <span class="keyword">null</span>) &#123;</div><div class="line">                        Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</div><div class="line">                        <span class="keyword">if</span> (findState.checkAdd(method, eventType)) &#123;</div><div class="line">                            ThreadMode threadMode = subscribeAnnotation.threadMode();</div><div class="line">                            findState.subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(method, eventType, threadMode,</div><div class="line">                                    subscribeAnnotation.priority(), subscribeAnnotation.sticky()));</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">                    String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"@Subscribe method "</span> + methodName +</div><div class="line">                            <span class="string">"must have exactly 1 parameter but has "</span> + parameterTypes.length);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strictMethodVerification &amp;&amp; method.isAnnotationPresent(Subscribe.class)) &#123;</div><div class="line">                String methodName = method.getDeclaringClass().getName() + <span class="string">"."</span> + method.getName();</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(methodName +</div><div class="line">                        <span class="string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>获取订阅类声明的所有方法; 然后对获取到的方法全部遍历一遍</li>
<li>获取方法的修饰符：即方法前面的public、private等关键字。</li>
<li>如果该类方法使用了@subscribe标注、方法中只有一个参数、且方法修饰符为public。findState.checkAdd(method, eventType) 如果之前没有存在过则返回true</li>
<li>判断@Subscribe标注中的threadMode对应的值，默认模式ThreadMode.POSTING</li>
<li>创建一个SubscriberMethod对象，该对象很简单就是保存有方法、方法参数类型、线程模式、订阅的优先级、sticky标志位。与Retrofit类似只是这里创建了一个SubscriberMethod对象。并将该对象添加到FindSate的List<subscribermethod>集合中。</subscribermethod></li>
</ol>
<p>回到注册方法，来看一下subscribe方法的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> </span>&#123;  </div><div class="line">        Class&lt;?&gt; eventType = subscriberMethod.eventType; <span class="comment">//note1  </span></div><div class="line">        Subscription newSubscription = <span class="keyword">new</span> Subscription(subscriber, subscriberMethod); <span class="comment">//note2  </span></div><div class="line">  </div><div class="line">        CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType); <span class="comment">//note3  </span></div><div class="line">        <span class="keyword">if</span> (subscriptions == <span class="keyword">null</span>) &#123;  </div><div class="line">            subscriptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();  </div><div class="line">            subscriptionsByEventType.put(eventType, subscriptions);  </div><div class="line">        &#125; <span class="keyword">else</span> &#123;  </div><div class="line">            <span class="keyword">if</span> (subscriptions.contains(newSubscription)) &#123;  </div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriber.getClass() + <span class="string">" already registered to event "</span> + eventType);   </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">int</span> size = subscriptions.size(); <span class="comment">//note4  </span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= size; i++) &#123;  </div><div class="line">            <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;  </div><div class="line">                subscriptions.add(i, newSubscription);  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber); <span class="comment">//note5  </span></div><div class="line">        <span class="keyword">if</span> (subscribedEvents == <span class="keyword">null</span>) &#123;  </div><div class="line">            subscribedEvents = <span class="keyword">new</span> ArrayList&lt;&gt;();  </div><div class="line">            typesBySubscriber.put(subscriber, subscribedEvents);  </div><div class="line">        &#125;  </div><div class="line">        subscribedEvents.add(eventType);  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span> (subscriberMethod.sticky) &#123; <span class="comment">//note6  </span></div><div class="line">            <span class="keyword">if</span> (eventInheritance) &#123;  </div><div class="line">                Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();  </div><div class="line">                <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;  </div><div class="line">                    Class&lt;?&gt; candidateEventType = entry.getKey();  </div><div class="line">                    <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123; <span class="comment">//从stickyEvents获取对应的事件交给当前事件订阅者处理  </span></div><div class="line">                        Object stickyEvent = entry.getValue();  </div><div class="line">                        checkPostStickyEventToSubscription(newSubscription, stickyEvent); <span class="comment">//该方法底层还是会执行postToSubscription方法  </span></div><div class="line">                    &#125;  </div><div class="line">                &#125;  </div><div class="line">            &#125; <span class="keyword">else</span> &#123;  </div><div class="line">                Object stickyEvent = stickyEvents.get(eventType);  </div><div class="line">                checkPostStickyEventToSubscription(newSubscription, stickyEvent);  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>获取方法参数类型；注意：使用@Subscribe标注的方法有且仅有一个参数</li>
<li>利用订阅者对象及其事件处理方法构建一个Subscription对象，该对象存储有Object、SubscriberMethod对象</li>
<li>从subscriptionsByEventType集合中获取当前事件对应的Subscription对象集合; 如果得到的集合为空则创建一个这样的集合，并将刚创建的Subscription对象添加进subscriptionsByEventType集合中；如果得到的集合不为空且刚创建的Subscription对象已经存在该集合中则抛出异常，即同一个对象不能注册两次！</li>
<li>将第二步创建的Subscription对象按照优先级存入Subscription对象集合中，该集合中的元素都是按照优先级从高到低存放.</li>
<li>以subscriber对象为键，从typesBySubscriber获取该对象对应的接收事件类型集合，没有则创建一个这样的集合，然后当前事件类型添加到该集合中，最后将整个集合添加进typesBySubscriber集合中；有则直接添加到接收事件类型集合中；</li>
<li>该值默认为false，除非在注册事件方法时使用了如下的标注@Subscribe(sticky = true)；那么就会执行到这里。stickyEvent也是EventBus3.0的一大特点，该类事件一旦发送给EventBus，那么EventBus就会将它存入Map<class<?>, Object&gt; stickyEvents集合中，key事件类型，value事件实例；每个类型事件对应最新的实例。当订阅对象的某个事件处理方法使用了@Subscribe(sticky = true)标注，EventBus一旦对订阅者完成了注册任务之后，立即将stickyEvents集合中的匹配事件发送给该事件处理进行处理！</class<?></li>
</ol>
<p>接下来看post方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;  </div><div class="line">        PostingThreadState postingState = currentPostingThreadState.get(); <span class="comment">//note1  </span></div><div class="line">        List&lt;Object&gt; eventQueue = postingState.eventQueue;   </div><div class="line">        eventQueue.add(event); <span class="comment">//note2  </span></div><div class="line">        <span class="keyword">if</span> (!postingState.isPosting) &#123;   </div><div class="line">            postingState.isMainThread = Looper.getMainLooper() == Looper.myLooper();  </div><div class="line">            postingState.isPosting = <span class="keyword">true</span>;  </div><div class="line">            <span class="keyword">if</span> (postingState.canceled) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Internal error. Abort state was not reset"</span>); &#125;  </div><div class="line">            <span class="keyword">try</span> &#123;  </div><div class="line">                <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123;  </div><div class="line">                    postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState);<span class="comment">//note3  </span></div><div class="line">                &#125;  </div><div class="line">            &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">                postingState.isPosting = <span class="keyword">false</span>;  </div><div class="line">                postingState.isMainThread = <span class="keyword">false</span>;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>获取当前线程对应的一个PostingThreadState()对象；回顾一下我们在EventBus中创建的如下域</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;PostingThreadState&gt; currentPostingThreadState = <span class="keyword">new</span> ThreadLocal&lt;PostingThreadState&gt;() &#123;    </div><div class="line">        <span class="meta">@Override</span>  <span class="function"><span class="keyword">protected</span> PostingThreadState <span class="title">initialValue</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> PostingThreadState(); &#125; <span class="comment">//当前推送线程状态   </span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>ThreadLocal类型的特点是当调用currentPostingThreadState.get()方法的时候，会返回当前线程所持有的一个 PostingThreadState对象；在不同的线程中执行同样一行代码它们得到的对象是不同的。PostingThreadState也很简单，就是定义了一堆数据，没有任何方法。下面就是它的所有源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PostingThreadState</span> </span>&#123;  </div><div class="line">        <span class="keyword">final</span> List&lt;Object&gt; eventQueue = <span class="keyword">new</span> ArrayList&lt;Object&gt;(); <span class="comment">//待派送的事件队列  </span></div><div class="line">        <span class="keyword">boolean</span> isPosting; <span class="comment">//当前PostingThreadState对象是否正在派送事件的标志位  </span></div><div class="line">        <span class="keyword">boolean</span> isMainThread; <span class="comment">//当前PostingThreadState对象是否是工作在UI线程的标志位  </span></div><div class="line">        Subscription subscription; <span class="comment">//事件处理器  </span></div><div class="line">        Object event; <span class="comment">//待处理事件  </span></div><div class="line">        <span class="keyword">boolean</span> canceled; <span class="comment">//是否取消事件派送的标志位  </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>向PostingThreadState的事件队列中添加一个事件</li>
<li>从PostingThreadState的事件队列——eventQueue中移出一个事件，并调用postSingleEvent方法进行派送</li>
</ol>
<p>postSingleEvent方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> <span class="keyword">throws</span> Error </span>&#123;  </div><div class="line">        Class&lt;?&gt; eventClass = event.getClass();  </div><div class="line">        <span class="keyword">boolean</span> subscriptionFound = <span class="keyword">false</span>;  </div><div class="line">        <span class="keyword">if</span> (eventInheritance) &#123;   </div><div class="line">            List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass); <span class="comment">//note2  </span></div><div class="line">            <span class="keyword">int</span> countTypes = eventTypes.size();  </div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; countTypes; h++) &#123; <span class="comment">//note3  </span></div><div class="line">                Class&lt;?&gt; clazz = eventTypes.get(h);  </div><div class="line">                subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);  </div><div class="line">            &#125;  </div><div class="line">        &#125; <span class="keyword">else</span> &#123;  </div><div class="line">            subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">if</span> (!subscriptionFound) &#123; <span class="comment">//note4  </span></div><div class="line">            <span class="keyword">if</span> (logNoSubscriberMessages) &#123;  </div><div class="line">                Log.d(TAG, <span class="string">"No subscribers registered for event "</span> + eventClass);  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">if</span> (sendNoSubscriberEvent &amp;&amp; eventClass != NoSubscriberEvent.class &amp;&amp;eventClass != SubscriberExceptionEvent.class) &#123;  </div><div class="line">                post(<span class="keyword">new</span> NoSubscriberEvent(<span class="keyword">this</span>, event));  </div><div class="line">            &#125;  </div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<ol>
<li>eventInheritance该标志位默认为true，表示只要 满足订阅事件是该事件的父类或者实现了该事件同样接口或接口父类 中的任何一个条件的订阅者都会来处理该事件。</li>
<li>该方法从名字来看就是获取eventClass的所有父类往上都能追溯到Object、和所有实现的接口、以及接口父类；EventBus进行了优化采用了缓存机制Map<class<?>, List<class<?>&gt;&gt; eventTypesCache。</class<?></class<?></li>
<li>将eventClass所有的关联类都通过postSingleEventForEventType进行推送；下面跟着就会分析该方法</li>
<li>如果该事件没有推送成功，即没有事件处理器来处理这类事件；系统会尝试发送一个post(new NoSubscriberEvent(this, event))事件</li>
</ol>
<p>postSingleEventForEventType方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span> </span>&#123;  </div><div class="line">        <span class="comment">//第一个是带处理的原始事件，第三个参数是原始事件的关联类  </span></div><div class="line">        CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;  </div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;  </div><div class="line">            subscriptions = subscriptionsByEventType.get(eventClass);<span class="comment">//note1  </span></div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;  </div><div class="line">            <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;  </div><div class="line">                postingState.event = event;  </div><div class="line">                postingState.subscription = subscription;  </div><div class="line">                <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;  </div><div class="line">                <span class="keyword">try</span> &#123;  </div><div class="line">                    postToSubscription(subscription, event, postingState.isMainThread); <span class="comment">//note2  </span></div><div class="line">                    aborted = postingState.canceled;  </div><div class="line">                &#125; <span class="keyword">finally</span> &#123;  </div><div class="line">                    postingState.event = <span class="keyword">null</span>;  </div><div class="line">                    postingState.subscription = <span class="keyword">null</span>;  </div><div class="line">                    postingState.canceled = <span class="keyword">false</span>;  </div><div class="line">                &#125;  </div><div class="line">                <span class="keyword">if</span> (aborted) &#123;  </div><div class="line">                    <span class="keyword">break</span>;  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>获取原始事件的关联类对应的所有Subscription对象</li>
<li>将上述Subscription对象集合进行遍历，使用postToSubscription方法处理原始事件</li>
</ol>
<p>postToSubscription方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> </span>&#123;  </div><div class="line">        <span class="comment">//第一个参数是事件处理器、第二个参数是待处理事件、第三个为当前线程是否是UI线程的标志位  </span></div><div class="line">        <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;  </div><div class="line">            <span class="keyword">case</span> POSTING: <span class="comment">//note1  </span></div><div class="line">                invokeSubscriber(subscription, event);  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            <span class="keyword">case</span> MAIN: <span class="comment">//note2  </span></div><div class="line">                <span class="keyword">if</span> (isMainThread) &#123;  </div><div class="line">                    invokeSubscriber(subscription, event);  </div><div class="line">                &#125; <span class="keyword">else</span> &#123;  </div><div class="line">                    mainThreadPoster.enqueue(subscription, event);  </div><div class="line">                &#125;  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            <span class="keyword">case</span> BACKGROUND: <span class="comment">//note3  </span></div><div class="line">                <span class="keyword">if</span> (isMainThread) &#123;  </div><div class="line">                    backgroundPoster.enqueue(subscription, event);  </div><div class="line">                &#125; <span class="keyword">else</span> &#123;  </div><div class="line">                    invokeSubscriber(subscription, event);  </div><div class="line">                &#125;  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            <span class="keyword">case</span> ASYNC: <span class="comment">//note4  </span></div><div class="line">                asyncPoster.enqueue(subscription, event);  </div><div class="line">                <span class="keyword">break</span>;  </div><div class="line">            <span class="keyword">default</span>:  </div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);  </div><div class="line">        &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>POSTING直接在当前线程执行，调用invokeSubscriber方法</li>
<li>MAIN即UI线程执行：如果当前线程就是UI线程则直接调用invokeSubscriber方法，否则将任务交给mainThreadPoster——HandlerPoster(this, Looper.getMainLooper(), 10)对象异步执行，最终会调用invokeSubscriber(PendingPost pendingPost)方法；</li>
<li>BACKGROUND背景线程执行：其实就在非UI线程中执行，如果当前线程是非UI线程则直接调用invokeSubscriber方法，否则将任务交给backgroundPoster——BackgroundPoster(this)对象异步执行，最终会调用invokeSubscriber(PendingPost pendingPost)方法；</li>
<li>ASYNC：将任务交给 asyncPoster—— AsyncPoster(this)对象异步执行，最终会调用invokeSubscriber(PendingPost pendingPost)方法；</li>
<li>就是根据不同的Post模式，选择不同的方式反射执行方法。</li>
</ol>
<p>接下来看取消注册的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;  </div><div class="line">        List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber);<span class="comment">//note1  </span></div><div class="line">        <span class="keyword">if</span> (subscribedTypes != <span class="keyword">null</span>) &#123;  </div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;  </div><div class="line">                unsubscribeByEventType(subscriber, eventType); <span class="comment">//  </span></div><div class="line">            &#125;  </div><div class="line">            typesBySubscriber.remove(subscriber); <span class="comment">//note3  </span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;  </div><div class="line">            Log.w(TAG, <span class="string">"Subscriber to unregister was not registered before: "</span> + subscriber.getClass());  </div><div class="line">        &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>从typesBySubscriber获取该对象接收的事件类型集合；</li>
<li>对得到的接收事件类型集合中的每个事件类型调用unsubscribeByEventType进行处理；跟着我们就分析该方法</li>
<li>该对象从typesBySubscriber集合中移除；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsubscribeByEventType</span><span class="params">(Object subscriber, Class&lt;?&gt; eventType)</span> </span>&#123;  </div><div class="line">        List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType); <span class="comment">//note1  </span></div><div class="line">        <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span>) &#123;  </div><div class="line">            <span class="keyword">int</span> size = subscriptions.size();  </div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;  </div><div class="line">                Subscription subscription = subscriptions.get(i);  </div><div class="line">                <span class="keyword">if</span> (subscription.subscriber == subscriber) &#123; <span class="comment">//note2  </span></div><div class="line">                    subscription.active = <span class="keyword">false</span>;  </div><div class="line">                    subscriptions.remove(i);  </div><div class="line">                    i--;  </div><div class="line">                    size--;  </div><div class="line">                &#125;  </div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>1、从subscriptionsByEventType集合中获取该事件类型对应的Subscription集合<br>2、如果集合中的元素——Subscription的subscriber域等于目标subscriber，则将该Subscription从subscriptionsByEventType集合中移除出去；</p>
<pre><code>源码部分就讲解到这里
由于对注解不是很了解，所以在通过索引获取订阅方法的时候我也是一脸蒙逼，因为索引列表是在构造函数中生成的。但是addIndex从来没被调用过。我就很好奇索引列表是怎么来的，后面才明白是另外有方法来添加订阅者索引列表，下面我们来看一下如何使用索引。
</code></pre><h2 id="索引的好处"><a href="#索引的好处" class="headerlink" title="索引的好处"></a>索引的好处</h2><p>EventBus提供了一个扩展包 EventBusAnnotationProcessor 这个方法可以在编译的时候通过注解，自动生成订阅方法索引列表的类。由于是在编译阶段就执行的，这样做可以避免反射获取所需的耗时。缺点可能是会占用一小部分内存。</p>
<h2 id="如何使用索引"><a href="#如何使用索引" class="headerlink" title="如何使用索引"></a>如何使用索引</h2><p>使用索引需要在项目gradle下添加 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">classpath <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></div></pre></td></tr></table></figure>
<p>如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></div><div class="line"></div><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">        mavenCentral()</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath <span class="string">'com.android.tools.build:gradle:2.3.0'</span></div><div class="line"></div><div class="line">        classpath <span class="string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span></div><div class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></div><div class="line">        <span class="comment">// in the individual module build.gradle files</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">allprojects &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">task <span class="title">clean</span><span class="params">(type: Delete)</span> </span>&#123;</div><div class="line">    delete rootProject.buildDir</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在app的gradle中添加<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//apply 需添加</span></div><div class="line">apply plugin: <span class="string">'com.neenbedankt.android-apt'</span></div><div class="line"><span class="comment">//android中需添加</span></div><div class="line">android &#123;</div><div class="line">	apt&#123;</div><div class="line">        arguments&#123;</div><div class="line">	        <span class="comment">//路径加类名，用来确定存放的位置，可以自己定义</span></div><div class="line">            eventBusIndex <span class="string">"org.greenrobot.eventbus.EventBusTestIndex"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//dependencies需添加</span></div><div class="line">dependencies &#123;</div><div class="line">    provided <span class="string">'org.greenrobot:eventbus-annotation-processor:3.0.1'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中eventBusIndex 是路径加类名，用来确定存放的位置，可以自己定义。<br>配置完之后先Rebuild一把<br><img src="http://img.blog.csdn.net/20170330145236125?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ3VveGlhb2xvbmdvbmx5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"><br>可以看到在debug目录下生成了这个EventBusTestIndex这个类。</p>
<p>类中方法如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.greenrobot.eventbus;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SimpleSubscriberInfo;</div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SubscriberMethodInfo;</div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SubscriberInfo;</div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.meta.SubscriberInfoIndex;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.ThreadMode;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="comment">/** This class is generated by EventBus, do not edit. */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventBusTestIndex</span> <span class="keyword">implements</span> <span class="title">SubscriberInfoIndex</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, SubscriberInfo&gt; SUBSCRIBER_INDEX;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        SUBSCRIBER_INDEX = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, SubscriberInfo&gt;();</div><div class="line"></div><div class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(com.cncn.tourenforce.base.BaseFuncActivity.class, <span class="keyword">true</span>,</div><div class="line">                <span class="keyword">new</span> SubscriberMethodInfo[] &#123;</div><div class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"logoutEvent"</span>, com.cncn.tourenforce.bean.event.LogoutEvent.class),</div><div class="line">        &#125;));</div><div class="line"></div><div class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(com.cncn.tourenforce.ui.mine.AboutActivity.class, <span class="keyword">true</span>,</div><div class="line">                <span class="keyword">new</span> SubscriberMethodInfo[] &#123;</div><div class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"downLoadSuccess"</span>, com.cncn.tourenforce.bean.event.UpdateVersionEvent.class),</div><div class="line">        &#125;));</div><div class="line"></div><div class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(com.cncn.tourenforce.ui.check.CheckReasonEditActivity.class, <span class="keyword">true</span>,</div><div class="line">                <span class="keyword">new</span> SubscriberMethodInfo[] &#123;</div><div class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"checkSuccess"</span>, com.cncn.tourenforce.bean.event.CheckSuccessEvent.class),</div><div class="line">        &#125;));</div><div class="line"></div><div class="line">        putIndex(<span class="keyword">new</span> SimpleSubscriberInfo(com.cncn.tourenforce.ui.check.SignListFragment.class, <span class="keyword">true</span>,</div><div class="line">                <span class="keyword">new</span> SubscriberMethodInfo[] &#123;</div><div class="line">            <span class="keyword">new</span> SubscriberMethodInfo(<span class="string">"resetList"</span>, com.cncn.tourenforce.bean.event.SignSelectResetEvent.class),</div><div class="line">        &#125;));</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putIndex</span><span class="params">(SubscriberInfo info)</span> </span>&#123;</div><div class="line">        SUBSCRIBER_INDEX.put(info.getSubscriberClass(), info);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SubscriberInfo <span class="title">getSubscriberInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</div><div class="line">        SubscriberInfo info = SUBSCRIBER_INDEX.get(subscriberClass);</div><div class="line">        <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> info;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>就是一个静态的Map对象用来存放所有订阅方法字典。然后提供一个get方法用来获取这个字典中的对象。</p>
<p>然后就是使用了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EventBus.builder().addIndex(subscriberClass -&gt; <span class="keyword">new</span> EventBusTestIndex().getSubscriberInfo(subscriberClass)).installDefaultEventBus();</div></pre></td></tr></table></figure>
<p>这边再贴一遍installDefaultEventBus这个方法的源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Installs the default EventBus returned by &#123;<span class="doctag">@link</span> EventBus#getDefault()&#125; using this builders' values. Must be</div><div class="line">   * done only once before the first usage of the default EventBus.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@throws</span> EventBusException if there's already a default EventBus instance in place</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> EventBus <span class="title">installDefaultEventBus</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">synchronized</span> (EventBus.class) &#123;</div><div class="line">          <span class="keyword">if</span> (EventBus.defaultInstance != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Default instance already exists."</span> +</div><div class="line">                      <span class="string">" It may be only set once before it's used the first time to ensure consistent behavior."</span>);</div><div class="line">          &#125;</div><div class="line">          EventBus.defaultInstance = build();</div><div class="line">          <span class="keyword">return</span> EventBus.defaultInstance;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>可以看出这个方法用来自定义一个EventBusBuider对象配置到EventBus中去，并替换掉defaultInstance。<br>注意：这里需要在Default EventBus 对象还没生成的时候执行这句话。如果已经有默认的EventBus对象存在了再installDefaultEventBus会报错的。</p>
<p>所以我们需要在APP启动的时候把这个方法加进去，新建一个App类继承Application</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> android.app.Application;</div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.EventBus;</div><div class="line"><span class="keyword">import</span> org.greenrobot.eventbus.EventBusTestIndex;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        EventBus.builder().addIndex(subscriberClass -&gt; <span class="keyword">new</span> EventBusTestIndex().getSubscriberInfo(subscriberClass)).installDefaultEventBus();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AndroidManifest中别忘了把Application改成当前App<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">application</span></span></div><div class="line">        <span class="attr">android:name</span>=<span class="string">".base.App"</span></div><div class="line">        <span class="attr">android:allowBackup</span>=<span class="string">"true"</span></div><div class="line">        <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></div><div class="line">        <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></div><div class="line">        <span class="attr">android:theme</span>=<span class="string">"@style/CustomAppTheme"</span>&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>之后的方法获取就都是通过索引获取了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><pre><code>没有精确去分析所有的源码。这边大概做一下总结，整个流程大概如下。
1. 注册EventBus，EventBus会获取当前类中的订阅方法，包括方法的参数，类型，优先级等信息。在获取的方法中，经常会有缓存。如果在缓存中没有才去调用获取方法。获取订阅方法有两种方式，一种是反射，反射获取全部方法，找到加了@Subscribe注解并有一个参数的方法，另外一种是通过订阅方法索引来得到订阅方法。反射的效率较低，所以一般都是用订阅方法索引来获取，有些情况下找不到这个方法。它还是会走反射的途径。注册过后这个订阅方法就被存起来了。等待接受消息。（这边值得说一下在3.0以前是没有注解方法的那时候都是通过反射来获取和执行方法。而且方法必须以onEvent开头，分别为onEventMainThead,onEventBackground,onEvent,onEventAsync)
3. postEvent，会把这个Event加入消息队列，然后通过Event的类型信息来得到它的订阅方法，然后根据相应的订阅方式反射调用订阅方法。没有选择的Post一般都会在UI线程执行。如果当前post不是UI线程这边会用Handle的机制来让方法运行在UI线程。
4. 解除注册，将该对象从对象缓存列表中移除，获取当前对象的订阅列表，然后将其从订阅列表移除
</code></pre>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/学习/" rel="tag"># 学习</a>
          
            <a href="/tags/EventBus源码解析/" rel="tag"># EventBus源码解析</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/02/23/MeetMomeryLeak/" rel="next" title="初识内存泄露">
                <i class="fa fa-chevron-left"></i> 初识内存泄露
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/31/MPAndroidChartSource/" rel="prev" title="MPAndroidChart">
                MPAndroidChart <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/lucky.jpg"
               alt="小龙" />
          <p class="site-author-name" itemprop="name">小龙</p>
           
              <p class="site-description motion-element" itemprop="description">程序猿</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xiaolongonly" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/guoxiaolongonly" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-android"></i>
                  
                  CSDN
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要使用EventBus"><span class="nav-number">1.</span> <span class="nav-text">为什么要使用EventBus</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EventBus使用"><span class="nav-number">2.</span> <span class="nav-text">EventBus使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EventBus源码解析"><span class="nav-number">3.</span> <span class="nav-text">EventBus源码解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#索引的好处"><span class="nav-number">4.</span> <span class="nav-text">索引的好处</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何使用索引"><span class="nav-number">5.</span> <span class="nav-text">如何使用索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小龙</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
